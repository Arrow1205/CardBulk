<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CardVault</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;600;700;800;900&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0c0c0e;
  --surface: #111114;
  --surface2: #18181d;
  --surface3: #1f1f26;
  --border: rgba(255,255,255,0.06);
  --border2: rgba(255,255,255,0.11);
  --accent: #e8a020;
  --text: #f4f4f6;
  --text-dim: rgba(244,244,246,0.38);
  --text-mid: rgba(244,244,246,0.62);
  --gold: #e8a020;
  --tab-h: 72px;
  --safe: env(safe-area-inset-bottom, 12px);
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body { height:100%; overflow:hidden; background:var(--bg); color:var(--text); font-family:'Barlow',sans-serif; }
.page { position:absolute; inset:0; bottom:var(--tab-h); overflow-y:auto; overflow-x:hidden; display:none; -webkit-overflow-scrolling:touch; }
.page.active { display:block; }
.page-inner { padding-bottom:28px; min-height:100%; }
::-webkit-scrollbar { display:none; }

/* TAB BAR */
.tabbar { position:fixed; bottom:0; left:0; right:0; height:var(--tab-h); background:var(--surface); border-top:1px solid var(--border); display:flex; align-items:flex-start; padding-top:8px; padding-bottom:var(--safe); z-index:100; }
.tab-btn { flex:1; display:flex; flex-direction:column; align-items:center; gap:3px; background:none; border:none; cursor:pointer; color:var(--text-dim); font-family:'Barlow',sans-serif; font-size:10px; font-weight:500; letter-spacing:.5px; text-transform:uppercase; padding:0; transition:color .2s; }
.tab-btn.active { color:var(--accent); }
.tab-btn svg { width:22px; height:22px; stroke-width:1.6; }
.tab-btn.scan-btn { color:var(--text); position:relative; top:-14px; }
.scan-circle { width:52px; height:52px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; }
.scan-circle svg { stroke:var(--bg); }

/* HOME */
.home-hero { padding:52px 20px 16px; display:flex; justify-content:space-between; align-items:flex-end; }
.home-eyebrow { font-size:10px; font-weight:500; letter-spacing:2px; text-transform:uppercase; color:var(--text-dim); margin-bottom:4px; }
.home-big { font-family:'Barlow Condensed',sans-serif; font-size:40px; font-weight:900; letter-spacing:-.5px; line-height:1; }
.home-count { font-family:'Barlow Condensed',sans-serif; font-size:12px; font-weight:600; letter-spacing:1px; color:var(--text-dim); text-transform:uppercase; }

/* SEARCH */
.search-wrap { padding:0 20px 16px; }
.search-bar { background:var(--surface2); border:1px solid var(--border); border-radius:8px; display:flex; align-items:center; gap:10px; padding:0 13px; height:40px; }
.search-bar svg { color:var(--text-dim); flex-shrink:0; width:14px; height:14px; }
.search-bar input { background:none; border:none; outline:none; color:var(--text); font-family:'Barlow',sans-serif; font-size:14px; width:100%; }
.search-bar input::placeholder { color:var(--text-dim); }

/* SECTION */
.sec-row { display:flex; align-items:baseline; justify-content:space-between; padding:0 20px; margin-bottom:12px; }
.sec-title { font-family:'Barlow Condensed',sans-serif; font-size:16px; font-weight:800; letter-spacing:1px; text-transform:uppercase; }
.sec-sub { font-size:11px; color:var(--text-dim); }

/* FAV CARDS ‚Äî Zidane style */
.favs-scroll { overflow-x:auto; padding:0 20px 4px; display:flex; gap:11px; scrollbar-width:none; margin-bottom:24px; }
.fav-card { flex-shrink:0; width:138px; height:202px; border-radius:10px; overflow:hidden; position:relative; cursor:pointer; background:var(--surface2); border:1px solid var(--border2); display:flex; flex-direction:column; }
.fav-card-img { flex:1; overflow:hidden; position:relative; }
.fav-card-img img { width:100%; height:100%; object-fit:cover; display:block; }
.fav-card-img-empty { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:50px; background:var(--surface3); }
.fav-card-top { position:absolute; top:0; left:0; right:0; display:flex; justify-content:space-between; align-items:flex-start; padding:7px; z-index:2; }
.fav-rating { font-family:'Barlow Condensed',sans-serif; font-size:20px; font-weight:900; color:var(--bg); background:var(--accent); width:28px; height:28px; border-radius:4px; display:flex; align-items:center; justify-content:center; line-height:1; }
.fav-rating-empty { width:28px; }
.fav-card-bot { background:var(--surface); padding:7px 9px; border-top:1px solid var(--border); flex-shrink:0; }
.fav-card-name { font-family:'Barlow Condensed',sans-serif; font-size:13px; font-weight:800; line-height:1.15; text-transform:uppercase; letter-spacing:.3px; }
.fav-card-club { font-size:9px; font-weight:400; color:var(--text-dim); margin-top:1px; letter-spacing:.5px; text-transform:uppercase; }
.badge { display:inline-flex; align-items:center; gap:2px; background:var(--bg); border:1px solid var(--border2); border-radius:3px; padding:2px 5px; font-size:8px; font-weight:700; letter-spacing:.5px; text-transform:uppercase; }
.badge.auto { color:var(--gold); border-color:rgba(232,160,32,.3); }
.badge.patch { color:#6ee7b7; border-color:rgba(110,231,183,.25); }
.badge.rookie { color:#f9a8d4; border-color:rgba(249,168,212,.25); }
.badge.num { color:#93c5fd; border-color:rgba(147,197,253,.25); }
.fav-badges-top { display:flex; flex-direction:column; gap:3px; align-items:flex-end; }
.fav-empty { padding:20px; color:var(--text-dim); font-size:12px; font-weight:300; letter-spacing:.3px; }

/* CARD LIST ‚Äî NBA row style */
.cards-list { padding:0 20px; display:flex; flex-direction:column; gap:7px; }
.card-item { background:var(--surface); border:1px solid var(--border); border-radius:8px; display:flex; overflow:hidden; cursor:pointer; transition:background .1s; }
.card-item:active { background:var(--surface2); }
.card-sport-bar { width:3px; flex-shrink:0; }
.card-sport-bar.football { background:#3d6fff; }
.card-sport-bar.basketball { background:var(--accent); }
.card-sport-bar.tennis { background:#6ee7b7; }
.card-sport-bar.baseball { background:#f87171; }
.card-sport-bar.hockey { background:#93c5fd; }
.card-thumb { width:58px; height:84px; flex-shrink:0; overflow:hidden; background:var(--surface2); display:flex; align-items:center; justify-content:center; font-size:26px; }
.card-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
.card-info { flex:1; padding:9px 11px; display:flex; flex-direction:column; justify-content:center; gap:2px; min-width:0; }
.card-first { font-size:10px; font-weight:300; color:var(--text-mid); letter-spacing:.3px; }
.card-last { font-family:'Barlow Condensed',sans-serif; font-size:22px; font-weight:900; letter-spacing:.5px; text-transform:uppercase; line-height:1; }
.card-club-row { font-size:11px; color:var(--text-dim); display:flex; align-items:center; gap:5px; margin-top:2px; }
.card-badges-row { display:flex; gap:4px; flex-wrap:wrap; margin-top:5px; }
.card-right { padding:9px 11px 9px 0; display:flex; flex-direction:column; align-items:flex-end; justify-content:space-between; flex-shrink:0; }
.card-date { font-size:9px; color:var(--text-dim); font-weight:400; letter-spacing:.3px; }
.card-sport-ico { font-size:18px; }

/* COLLECTION */
.coll-header { padding:52px 20px 14px; display:flex; align-items:flex-end; justify-content:space-between; }
.coll-eyebrow { font-size:10px; font-weight:500; letter-spacing:2px; text-transform:uppercase; color:var(--text-dim); margin-bottom:4px; }
.coll-big { font-family:'Barlow Condensed',sans-serif; font-size:40px; font-weight:900; letter-spacing:-.5px; line-height:1; }
.hdr-btns { display:flex; gap:7px; }
.btn-icon { width:33px; height:33px; border-radius:7px; background:var(--surface2); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text); }

/* FILTERS */
.filters-row { padding:0 20px 14px; display:flex; gap:6px; overflow-x:auto; scrollbar-width:none; }
.filter-tag { flex-shrink:0; padding:5px 12px; border-radius:4px; font-size:10px; font-weight:700; letter-spacing:.8px; text-transform:uppercase; border:1px solid var(--border); background:var(--surface2); color:var(--text-dim); cursor:pointer; transition:all .1s; }
.filter-tag.active { background:var(--accent); border-color:var(--accent); color:var(--bg); }

/* FOLDERS */
.folders-grid { padding:0 20px; display:grid; grid-template-columns:1fr 1fr; gap:9px; margin-bottom:22px; }
.folder-card { background:var(--surface); border:1px solid var(--border); border-radius:9px; padding:13px; cursor:pointer; transition:background .1s; }
.folder-card:active { background:var(--surface2); }
.folder-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.folder-emoji { font-size:22px; }
.folder-n { font-family:'Barlow Condensed',sans-serif; font-size:22px; font-weight:900; color:var(--text-dim); }
.folder-name { font-family:'Barlow Condensed',sans-serif; font-size:15px; font-weight:800; text-transform:uppercase; letter-spacing:.5px; }
.folder-sub { font-size:9px; font-weight:400; color:var(--text-dim); margin-top:2px; letter-spacing:.5px; text-transform:uppercase; }
.folder-add { border:1px dashed var(--border2); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px; min-height:82px; color:var(--text-dim); }
.folder-add span { font-size:10px; font-weight:700; letter-spacing:.8px; text-transform:uppercase; }

/* CARDS GRID */
.colls-grid { padding:0 20px; display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
.coll-thumb { aspect-ratio:2/3; border-radius:7px; overflow:hidden; position:relative; background:var(--surface2); cursor:pointer; border:1px solid var(--border); }
.coll-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
.coll-thumb-empty { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:26px; }
.bulk-check { position:absolute; top:5px; left:5px; width:17px; height:17px; border-radius:50%; border:1.5px solid white; background:transparent; display:none; align-items:center; justify-content:center; }
.bulk-mode .bulk-check { display:flex; }
.bulk-check.checked { background:var(--accent); border-color:var(--accent); }

/* SHEETS */
.sheet-overlay { position:fixed; inset:0; background:rgba(0,0,0,.65); z-index:200; display:none; align-items:flex-end; backdrop-filter:blur(6px); }
.sheet-overlay.open { display:flex; }
.sheet { width:100%; background:var(--surface); border-radius:16px 16px 0 0; padding:10px 20px 40px; max-height:92vh; overflow-y:auto; animation:up .26s cubic-bezier(.32,1.2,.64,1); }
@keyframes up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-handle { width:30px; height:3px; background:var(--border2); border-radius:2px; margin:0 auto 16px; }
.sheet-title { font-family:'Barlow Condensed',sans-serif; font-size:24px; font-weight:900; text-transform:uppercase; letter-spacing:.5px; margin-bottom:18px; }

/* FORM */
.form-group { margin-bottom:13px; }
.form-label { font-size:10px; font-weight:700; letter-spacing:1.2px; text-transform:uppercase; color:var(--text-dim); margin-bottom:6px; display:block; }
.form-input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:7px; padding:10px 12px; color:var(--text); font-family:'Barlow',sans-serif; font-size:15px; outline:none; transition:border-color .2s; }
.form-input:focus { border-color:var(--accent); }
.form-input::placeholder { color:var(--text-dim); }
.form-select { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:7px; padding:10px 12px; color:var(--text); font-family:'Barlow',sans-serif; font-size:15px; outline:none; appearance:none; }
.toggle-row { display:flex; gap:7px; }
.toggle-btn { flex:1; padding:8px; border-radius:7px; border:1px solid var(--border); background:var(--surface2); color:var(--text-dim); font-size:10px; font-weight:700; cursor:pointer; text-align:center; transition:all .1s; letter-spacing:.5px; text-transform:uppercase; font-family:'Barlow',sans-serif; }
.toggle-btn.on { background:var(--accent); border-color:var(--accent); color:var(--bg); }

/* PHOTO */
.photo-upload { width:100%; aspect-ratio:3/2; border-radius:9px; border:1px dashed var(--border2); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:13px; color:var(--text-dim); position:relative; overflow:hidden; background:var(--surface2); }
.photo-btns { display:flex; gap:9px; }
.photo-btn { background:var(--surface3); border:1px solid var(--border2); color:var(--text); padding:8px 16px; border-radius:7px; font-size:11px; font-weight:700; cursor:pointer; font-family:'Barlow',sans-serif; letter-spacing:.5px; text-transform:uppercase; }
.crop-btn { margin-top:7px; width:100%; padding:8px; border-radius:7px; background:var(--surface2); border:1px solid var(--border); color:var(--text-mid); font-size:11px; font-weight:700; cursor:pointer; font-family:'Barlow',sans-serif; letter-spacing:.5px; text-transform:uppercase; }

/* BUTTONS */
.btn-primary { width:100%; padding:14px; border-radius:7px; background:var(--accent); border:none; color:var(--bg); font-family:'Barlow Condensed',sans-serif; font-size:18px; font-weight:900; cursor:pointer; margin-top:7px; letter-spacing:1px; text-transform:uppercase; }
.btn-secondary { flex:1; padding:12px; border-radius:7px; background:var(--surface2); border:1px solid var(--border); color:var(--text); font-family:'Barlow Condensed',sans-serif; font-size:16px; font-weight:800; cursor:pointer; letter-spacing:.8px; text-transform:uppercase; }
.btn-accent { flex:1; padding:12px; border-radius:7px; background:var(--accent); border:none; color:var(--bg); font-family:'Barlow Condensed',sans-serif; font-size:16px; font-weight:800; cursor:pointer; letter-spacing:.8px; text-transform:uppercase; }

/* CARD DETAIL */
.card-detail { position:fixed; inset:0; z-index:150; background:var(--bg); display:none; flex-direction:column; overflow:hidden; }
.card-detail.open { display:flex; }
.card-3d-scene { width:100%; height:54%; flex-shrink:0; display:flex; align-items:center; justify-content:center; perspective:1200px; background:var(--surface); position:relative; overflow:hidden; }
.card-bg-name { position:absolute; inset:0; font-family:'Barlow Condensed',sans-serif; font-size:88px; font-weight:900; color:rgba(255,255,255,.04); letter-spacing:-2px; text-transform:uppercase; pointer-events:none; overflow:hidden; text-align:center; line-height:.9; padding:0 8px; display:flex; align-items:center; justify-content:center; }
.card-3d { width:196px; height:284px; border-radius:11px; overflow:hidden; position:relative; transform-style:preserve-3d; box-shadow:0 10px 40px rgba(0,0,0,.7),0 0 0 1px rgba(255,255,255,.07); transition:transform .08s linear; will-change:transform; z-index:2; }
.card-3d img { width:100%; height:100%; object-fit:cover; position:absolute; inset:0; display:block; }
.card-3d-placeholder { width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; background:var(--surface2); }
.card-3d-holo { position:absolute; inset:0; border-radius:11px; opacity:0; background:linear-gradient(135deg,#ff006655,#00ff8855,#0088ff55,#ff00ff55,#ff006655); background-size:400% 400%; pointer-events:none; mix-blend-mode:screen; transition:opacity .3s; }
.card-3d.tilting .card-3d-holo { opacity:.3; animation:holo 3s linear infinite; }
@keyframes holo{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.detail-overlay-hdr { position:absolute; top:0; left:0; right:0; z-index:10; padding:50px 15px 0; display:flex; align-items:center; justify-content:space-between; }
.back-btn { width:32px; height:32px; border-radius:50%; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center; }
.fav-btn-d { width:32px; height:32px; border-radius:50%; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:14px; }

/* Info panel */
.detail-info { flex:1; background:var(--surface); overflow-y:auto; border-top:1px solid var(--border); }
.player-id { padding:16px 18px 12px; border-bottom:1px solid var(--border); display:flex; align-items:flex-end; justify-content:space-between; }
.player-first { font-size:11px; font-weight:300; color:var(--text-mid); letter-spacing:.3px; }
.player-last { font-family:'Barlow Condensed',sans-serif; font-size:34px; font-weight:900; letter-spacing:-.5px; text-transform:uppercase; line-height:1; cursor:pointer; }
.player-meta { display:flex; align-items:center; gap:7px; margin-top:4px; }
.player-club-emoji { font-size:16px; }
.player-club { font-size:11px; color:var(--text-dim); letter-spacing:.5px; text-transform:uppercase; }
.sep { width:1px; height:14px; background:var(--border2); }
.player-sport-label { font-size:10px; font-weight:600; color:var(--text-dim); letter-spacing:.8px; text-transform:uppercase; }
.player-right { text-align:right; flex-shrink:0; }
.player-num-badge { font-family:'Barlow Condensed',sans-serif; font-size:13px; font-weight:800; color:var(--accent); letter-spacing:.5px; }
.player-badges { display:flex; gap:4px; flex-wrap:wrap; justify-content:flex-end; margin-top:5px; }

/* Info chips grid */
.chips-grid { display:grid; grid-template-columns:1fr 1fr; gap:1px; background:var(--border); }
.chip { background:var(--surface); padding:11px 15px; }
.chip-label { font-size:9px; font-weight:600; letter-spacing:1.2px; text-transform:uppercase; color:var(--text-dim); margin-bottom:3px; }
.chip-val { font-family:'Barlow Condensed',sans-serif; font-size:16px; font-weight:800; }

.detail-notes-wrap { padding:13px 18px; border-top:1px solid var(--border); }
.detail-notes-label { font-size:9px; font-weight:600; letter-spacing:1.2px; text-transform:uppercase; color:var(--text-dim); margin-bottom:5px; }
.detail-notes-val { font-size:13px; font-weight:300; color:var(--text-mid); line-height:1.5; }
.detail-actions { display:flex; gap:7px; padding:13px 18px 30px; }

/* COLLECTION VIEW */
.coll-view { position:fixed; inset:0; z-index:140; background:var(--bg); display:none; flex-direction:column; overflow:hidden; }
.coll-view.open { display:flex; }
.coll-view-hdr { padding:50px 20px 12px; display:flex; align-items:center; gap:11px; flex-shrink:0; border-bottom:1px solid var(--border); }
.coll-view-title { font-family:'Barlow Condensed',sans-serif; font-size:24px; font-weight:900; text-transform:uppercase; letter-spacing:.3px; flex:1; }
.coll-view-body { flex:1; overflow-y:auto; padding:13px 20px; }

/* BULK BAR */
.bulk-bar { position:fixed; bottom:var(--tab-h); left:0; right:0; padding:9px 15px; background:var(--surface); border-top:1px solid var(--border); display:none; gap:7px; z-index:160; }
.bulk-bar.show { display:flex; }

/* CLUBS */
.clubs-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-top:8px; }
.club-opt { background:var(--surface2); border:1px solid var(--border); border-radius:7px; padding:8px 5px; display:flex; flex-direction:column; align-items:center; gap:4px; cursor:pointer; transition:all .1s; }
.club-opt.sel { border-color:var(--accent); background:rgba(232,160,32,.1); }
.club-opt-logo { font-size:20px; }
.club-opt-name { font-size:9px; text-align:center; font-weight:600; color:var(--text-mid); letter-spacing:.3px; text-transform:uppercase; }

/* SCANNER */
.scanner-hdr { padding:50px 20px 14px; }
.scanner-title { font-family:'Barlow Condensed',sans-serif; font-size:38px; font-weight:900; text-transform:uppercase; letter-spacing:-.5px; }
.scanner-sub { font-size:12px; font-weight:300; color:var(--text-dim); margin-top:3px; letter-spacing:.3px; }

/* PLAYER AI */
.ai-hdr { display:flex; align-items:center; gap:13px; margin-bottom:14px; }
.ai-avatar { width:50px; height:50px; border-radius:50%; background:var(--surface2); border:1px solid var(--border2); display:flex; align-items:center; justify-content:center; font-size:20px; }
.ai-name { font-family:'Barlow Condensed',sans-serif; font-size:22px; font-weight:900; text-transform:uppercase; letter-spacing:.3px; line-height:1; }
.ai-sub { font-size:10px; font-weight:400; color:var(--text-dim); letter-spacing:.5px; text-transform:uppercase; margin-top:2px; }
.ai-desc { font-size:13px; font-weight:300; color:var(--text-mid); line-height:1.5; margin-bottom:16px; }
.ai-sec { margin-bottom:16px; }
.ai-sec-title { font-size:10px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--text-dim); margin-bottom:9px; padding-bottom:5px; border-bottom:1px solid var(--border); }
.ai-stats { display:flex; gap:7px; }
.ai-stat { flex:1; background:var(--surface2); border:1px solid var(--border); border-radius:7px; padding:9px; text-align:center; }
.ai-stat-label { font-size:9px; font-weight:600; letter-spacing:1px; text-transform:uppercase; color:var(--text-dim); margin-bottom:3px; }
.ai-stat-val { font-family:'Barlow Condensed',sans-serif; font-size:24px; font-weight:900; }
.ai-chart { height:68px; display:flex; align-items:flex-end; gap:5px; margin-bottom:20px; }
.ai-bar { flex:1; border-radius:3px 3px 0 0; background:var(--surface3); position:relative; min-height:4px; }
.ai-bar.cur { background:var(--accent); }
.ai-bar-v { position:absolute; top:-16px; left:50%; transform:translateX(-50%); font-size:9px; font-family:'Barlow Condensed',sans-serif; font-weight:700; color:var(--text-dim); white-space:nowrap; }
.ai-bar-y { position:absolute; bottom:-15px; left:50%; transform:translateX(-50%); font-size:8px; color:var(--text-dim); white-space:nowrap; }
.ai-clubs { display:flex; flex-direction:column; gap:5px; }
.ai-club-row { display:flex; align-items:center; gap:9px; background:var(--surface2); border-radius:7px; padding:8px 11px; border:1px solid var(--border); }
.ai-club-e { font-size:18px; width:26px; text-align:center; }
.ai-club-n { font-family:'Barlow Condensed',sans-serif; font-size:15px; font-weight:800; text-transform:uppercase; letter-spacing:.3px; }
.ai-club-y { font-size:10px; font-weight:300; color:var(--text-dim); margin-top:1px; }
.ai-loading { text-align:center; padding:34px; color:var(--text-dim); }
.ai-spin { width:20px; height:20px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .7s linear infinite; margin:0 auto 10px; }
@keyframes spin{to{transform:rotate(360deg)}}
.ai-note { font-size:10px; color:var(--text-dim); font-style:italic; padding:10px 0 0; text-align:center; letter-spacing:.3px; }

/* CROP */
.crop-overlay { position:fixed; inset:0; z-index:300; background:rgba(0,0,0,.96); display:none; flex-direction:column; align-items:center; justify-content:center; }
.crop-overlay.open { display:flex; }
.crop-label { color:var(--text-dim); font-size:10px; letter-spacing:1px; text-transform:uppercase; font-weight:600; margin-bottom:12px; }
.crop-wrap { position:relative; overflow:hidden; width:278px; height:396px; border-radius:9px; border:1px solid var(--border2); }
.crop-img { width:100%; height:100%; object-fit:cover; user-select:none; }
.crop-frame { position:absolute; inset:16px; border:2px solid rgba(255,255,255,.45); border-radius:5px; pointer-events:none; }
.crop-hint { color:var(--text-dim); font-size:10px; letter-spacing:.8px; text-transform:uppercase; margin-top:9px; font-weight:500; }
.crop-actions { display:flex; gap:9px; margin-top:18px; }
.crop-btn-a { padding:10px 28px; border-radius:7px; font-size:13px; font-weight:800; cursor:pointer; border:none; font-family:'Barlow Condensed',sans-serif; letter-spacing:.8px; text-transform:uppercase; }

/* GYRO BTN */
.gyro-btn { position:absolute; bottom:11px; left:50%; transform:translateX(-50%); background:var(--surface2); border:1px solid var(--border2); color:var(--text); padding:7px 17px; border-radius:5px; font-size:10px; font-weight:700; cursor:pointer; z-index:10; white-space:nowrap; font-family:'Barlow',sans-serif; letter-spacing:.8px; text-transform:uppercase; }

/* EMPTY */
.empty-state { text-align:center; padding:38px 22px; color:var(--text-dim); }
.empty-icon { font-size:44px; margin-bottom:12px; }
.empty-title { font-family:'Barlow Condensed',sans-serif; font-size:20px; font-weight:900; text-transform:uppercase; color:var(--text); margin-bottom:5px; letter-spacing:.5px; }
.empty-sub { font-size:12px; font-weight:300; line-height:1.6; letter-spacing:.3px; }

/* TOAST */
.toast { position:fixed; bottom:calc(var(--tab-h) + 13px); left:50%; transform:translateX(-50%) translateY(14px); background:var(--surface2); border:1px solid var(--border2); border-radius:5px; padding:8px 16px; font-size:11px; font-weight:700; letter-spacing:.5px; text-transform:uppercase; z-index:400; opacity:0; transition:all .26s; white-space:nowrap; }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- ‚ïê‚ïê HOME ‚ïê‚ïê -->
<div class="page active" id="page-home">
  <div class="page-inner">
    <div class="home-hero">
      <div><div class="home-eyebrow">Ma collection</div><div class="home-big">CardVault</div></div>
      <div class="home-count" id="home-count">0 cartes</div>
    </div>
    <div class="search-wrap">
      <div class="search-bar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input id="home-search" type="text" placeholder="Joueur, club, collection‚Ä¶" oninput="homeSearch(this.value)">
      </div>
    </div>
    <div style="margin-bottom:24px;">
      <div class="sec-row"><div class="sec-title">Favoris</div><div class="sec-sub" id="favs-count">0</div></div>
      <div class="favs-scroll" id="favs-container"><div class="fav-empty">Aucun favori ¬∑ marque des cartes avec ‚≠ê</div></div>
    </div>
    <div class="sec-row"><div class="sec-title">Derniers ajouts</div></div>
    <div class="cards-list" id="recent-list">
      <div class="empty-state"><div class="empty-icon">üÉè</div><div class="empty-title">Aucune carte</div><div class="empty-sub">Appuie sur le scanner pour commencer</div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SCANNER ‚ïê‚ïê -->
<div class="page" id="page-scanner">
  <div class="page-inner">
    <div class="scanner-hdr"><div class="scanner-title">Ajouter</div><div class="scanner-sub">Scanne ou uploade ta carte</div></div>
    <div style="padding:0 20px;">
      <div class="photo-upload" id="photo-upload-zone">
        <input type="file" id="card-photo-lib" accept="image/*" style="display:none" onchange="handlePhoto(this)">
        <input type="file" id="card-photo-cam" accept="image/*" capture="environment" style="display:none" onchange="handlePhoto(this)">
        <div id="photo-preview-wrap" style="display:none;position:absolute;inset:0;" onclick="document.getElementById('card-photo-lib').click()">
          <img id="photo-preview-img" style="width:100%;height:100%;object-fit:cover;">
          <div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.6);border-radius:4px;padding:3px 9px;font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">Changer</div>
        </div>
        <div id="photo-placeholder-ui">
          <div style="font-size:28px;">üì∏</div>
          <div class="photo-btns">
            <button class="photo-btn" type="button" onclick="document.getElementById('card-photo-cam').click()">üì∑ Cam√©ra</button>
            <button class="photo-btn" type="button" onclick="document.getElementById('card-photo-lib').click()">üñºÔ∏è Biblioth√®que</button>
          </div>
        </div>
      </div>
      <button class="crop-btn" id="crop-btn" style="display:none;" onclick="openCrop()">‚úÇÔ∏è Recadrer</button>
      <div style="height:16px;"></div>
      <div class="form-group"><label class="form-label">Pr√©nom</label><input class="form-input" id="f-prenom" type="text" placeholder="Kylian"></div>
      <div class="form-group"><label class="form-label">Nom</label><input class="form-input" id="f-nom" type="text" placeholder="Mbapp√©"></div>
      <div class="form-group">
        <label class="form-label">Club</label>
        <input class="form-input" id="f-club-search" type="text" placeholder="Rechercher un club‚Ä¶" oninput="filterClubs(this.value)" onfocus="showClubGrid()">
        <div class="clubs-grid" id="clubs-grid" style="display:none;"></div>
        <div id="sel-club-disp" style="display:none;margin-top:9px;align-items:center;gap:8px;"></div>
      </div>
      <div class="form-group"><label class="form-label">Sport</label>
        <select class="form-select" id="f-sport"><option value="">S√©lectionner</option><option value="football">‚öΩ Football</option><option value="basketball">üèÄ Basketball</option><option value="tennis">üéæ Tennis</option><option value="baseball">‚öæ Baseball</option><option value="hockey">üèí Hockey</option></select>
      </div>
      <div class="form-group">
        <label class="form-label">Num√©rot√©e</label>
        <div style="display:flex;gap:7px;align-items:center;">
          <div class="toggle-row" style="flex:1;"><button class="toggle-btn on" id="num-non" onclick="toggleNum(false)">Non</button><button class="toggle-btn" id="num-oui" onclick="toggleNum(true)">Oui</button></div>
          <input class="form-input" id="f-num" type="text" placeholder="/25" style="width:76px;display:none;">
        </div>
      </div>
      <div class="form-group"><label class="form-label">Sp√©cificit√©s</label><div class="toggle-row"><button class="toggle-btn" id="tog-auto" onclick="toggleTag('auto')">‚úçÔ∏è Auto</button><button class="toggle-btn" id="tog-patch" onclick="toggleTag('patch')">üéØ Patch</button><button class="toggle-btn" id="tog-rookie" onclick="toggleTag('rookie')">üåü Rookie</button></div></div>
      <div class="form-group"><label class="form-label">Collection</label><select class="form-select" id="f-collection"></select></div>
      <div id="new-coll-wrap" style="display:none;margin-top:7px;"><input class="form-input" id="f-new-coll" type="text" placeholder="Nom de la collection"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="f-notes" rows="3" placeholder="Valeur estim√©e, √©tat‚Ä¶"></textarea></div>
      <button class="btn-primary" onclick="saveCard()">Enregistrer la carte</button>
      <div style="height:22px;"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê COLLECTION ‚ïê‚ïê -->
<div class="page" id="page-collection">
  <div class="page-inner">
    <div class="coll-header">
      <div><div class="coll-eyebrow">Ma</div><div class="coll-big">Collection</div></div>
      <div class="hdr-btns">
        <div class="btn-icon" onclick="toggleBulk()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></div>
        <div class="btn-icon" onclick="openNewFolder()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg></div>
      </div>
    </div>
    <div class="search-wrap"><div class="search-bar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><input id="coll-search" type="text" placeholder="Rechercher‚Ä¶" oninput="collSearch(this.value)"></div></div>
    <div class="filters-row">
      <div class="filter-tag active" onclick="setFilter('all',this)">Tout</div>
      <div class="filter-tag" onclick="setFilter('auto',this)">Auto</div>
      <div class="filter-tag" onclick="setFilter('patch',this)">Patch</div>
      <div class="filter-tag" onclick="setFilter('rookie',this)">Rookie</div>
      <div class="filter-tag" onclick="setFilter('num',this)">Num√©rot√©e</div>
      <div class="filter-tag" onclick="setFilter('football',this)">‚öΩ Foot</div>
      <div class="filter-tag" onclick="setFilter('basketball',this)">üèÄ Basket</div>
      <div class="filter-tag" onclick="setFilter('tennis',this)">üéæ Tennis</div>
    </div>
    <div style="padding:0 20px 9px;"><div class="sec-title" style="font-size:13px;">Dossiers</div></div>
    <div class="folders-grid" id="folders-grid"><div class="folder-card folder-add" onclick="openNewFolder()"><span style="font-size:20px;">üìÅ</span><span>Nouveau</span></div></div>
    <div style="padding:0 20px 9px;"><div class="sec-title" style="font-size:13px;">Toutes les cartes</div></div>
    <div class="colls-grid" id="coll-grid"></div>
    <div id="coll-empty" class="empty-state" style="display:none;"><div class="empty-icon">üîç</div><div class="empty-title">Aucun r√©sultat</div><div class="empty-sub">Essaie d'autres filtres</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê TAB BAR ‚ïê‚ïê -->
<div class="tabbar">
  <button class="tab-btn active" onclick="navigate('home')" id="tab-home">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Accueil
  </button>
  <button class="tab-btn scan-btn" onclick="navigate('scanner')" id="tab-scanner">
    <div class="scan-circle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M5 3H3v2"/><path d="M19 3h2v2"/><path d="M5 21H3v-2"/><path d="M19 21h2v-2"/><rect x="7" y="7" width="10" height="10" rx="1"/></svg></div>Scanner
  </button>
  <button class="tab-btn" onclick="navigate('collection')" id="tab-collection">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3H8l-1 4h10z"/></svg>Collection
  </button>
</div>

<!-- ‚ïê‚ïê CARD DETAIL ‚ïê‚ïê -->
<div class="card-detail" id="card-detail">
  <div class="card-3d-scene" id="card-3d-scene">
    <div class="card-bg-name" id="card-bg-name"></div>
    <div class="detail-overlay-hdr">
      <button class="back-btn" onclick="closeDetail()"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
      <button class="fav-btn-d" id="detail-fav-btn" onclick="toggleFav()">‚òÜ</button>
    </div>
    <div class="card-3d" id="card-3d">
      <div id="card-3d-content" class="card-3d-placeholder">
        <span style="font-size:40px;opacity:.25;">üÉè</span>
        <span style="font-size:10px;color:var(--text-dim);font-weight:300;letter-spacing:.5px;text-transform:uppercase;">Aucune photo</span>
      </div>
      <div class="card-3d-holo"></div>
    </div>
  </div>
  <div class="detail-info" id="detail-info">
    <div class="player-id">
      <div>
        <div class="player-first" id="detail-prenom"></div>
        <div class="player-last" id="detail-nom" onclick="openPlayerAI()">‚Äî</div>
        <div class="player-meta">
          <span class="player-club-emoji" id="detail-club-e"></span>
          <span class="player-club" id="detail-club-n">‚Äî</span>
          <span class="sep" id="detail-sep" style="display:none;"></span>
          <span class="player-sport-label" id="detail-sport-label"></span>
        </div>
      </div>
      <div class="player-right">
        <div class="player-num-badge" id="detail-num" style="display:none;"></div>
        <div class="player-badges" id="detail-badges"></div>
      </div>
    </div>
    <div class="chips-grid">
      <div class="chip"><div class="chip-label">Collection</div><div class="chip-val" id="d-coll">‚Äî</div></div>
      <div class="chip"><div class="chip-label">Num√©rot√©e</div><div class="chip-val" id="d-num">‚Äî</div></div>
      <div class="chip"><div class="chip-label">Sport</div><div class="chip-val" id="d-sport">‚Äî</div></div>
      <div class="chip"><div class="chip-label">Ajout√© le</div><div class="chip-val" id="d-date">‚Äî</div></div>
    </div>
    <div class="detail-notes-wrap" id="d-notes-wrap" style="display:none;">
      <div class="detail-notes-label">Notes</div>
      <div class="detail-notes-val" id="d-notes-val"></div>
    </div>
    <div class="detail-actions">
      <button class="btn-secondary" onclick="editCurrentCard()">‚úèÔ∏è Modifier</button>
      <button class="btn-accent" onclick="openPlayerAI()">ü§ñ Stats IA</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê COLL VIEW ‚ïê‚ïê -->
<div class="coll-view" id="coll-view">
  <div class="coll-view-hdr">
    <button class="back-btn" onclick="closeCollView()"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
    <div class="coll-view-title" id="coll-view-title">Dossier</div>
    <div class="btn-icon" onclick="deleteCurrentFolder()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg></div>
  </div>
  <div class="coll-view-body"><div class="colls-grid" id="folder-cards-grid"></div></div>
</div>

<!-- BULK BAR -->
<div class="bulk-bar" id="bulk-bar">
  <button class="btn-secondary" style="flex:0 0 auto;padding:9px 13px;" onclick="cancelBulk()">Annuler</button>
  <select class="form-select" id="bulk-dest" style="flex:1;"></select>
  <button class="btn-accent" style="flex:0 0 auto;padding:9px 13px;" onclick="executeBulk()">‚úì</button>
</div>

<!-- ‚ïê‚ïê EDIT SHEET ‚ïê‚ïê -->
<div class="sheet-overlay" id="edit-sheet" onclick="closeSheet('edit-sheet',event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div><div class="sheet-title">Modifier</div>
    <div class="form-group"><label class="form-label">Pr√©nom</label><input class="form-input" id="e-prenom" type="text"></div>
    <div class="form-group"><label class="form-label">Nom</label><input class="form-input" id="e-nom" type="text"></div>
    <div class="form-group"><label class="form-label">Club</label><input class="form-input" id="e-club" type="text"></div>
    <div class="form-group"><label class="form-label">Sport</label><select class="form-select" id="e-sport"><option value="">S√©lectionner</option><option value="football">‚öΩ Football</option><option value="basketball">üèÄ Basketball</option><option value="tennis">üéæ Tennis</option><option value="baseball">‚öæ Baseball</option><option value="hockey">üèí Hockey</option></select></div>
    <div class="form-group"><label class="form-label">Num√©rot√©e (/X)</label><input class="form-input" id="e-num" type="text" placeholder="/25"></div>
    <div class="form-group"><label class="form-label">Sp√©cificit√©s</label><div class="toggle-row"><button class="toggle-btn" id="e-tog-auto" onclick="eTogTag('auto')">‚úçÔ∏è Auto</button><button class="toggle-btn" id="e-tog-patch" onclick="eTogTag('patch')">üéØ Patch</button><button class="toggle-btn" id="e-tog-rookie" onclick="eTogTag('rookie')">üåü Rookie</button></div></div>
    <div class="form-group"><label class="form-label">Collection</label><select class="form-select" id="e-collection"></select></div>
    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="e-notes" rows="3"></textarea></div>
    <button class="btn-primary" onclick="saveEdit()">Sauvegarder</button>
  </div>
</div>

<!-- ‚ïê‚ïê PLAYER SHEET ‚ïê‚ïê -->
<div class="sheet-overlay" id="player-sheet" onclick="closeSheet('player-sheet',event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div id="player-ai-content"><div class="ai-loading"><div class="ai-spin"></div>Analyse en cours‚Ä¶</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê FOLDER SHEET ‚ïê‚ïê -->
<div class="sheet-overlay" id="folder-sheet" onclick="closeSheet('folder-sheet',event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div><div class="sheet-title">Nouveau dossier</div>
    <div class="form-group"><label class="form-label">Nom</label><input class="form-input" id="new-folder-name" type="text" placeholder="ex: Rookies 2024"></div>
    <div class="form-group"><label class="form-label">Ic√¥ne</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">üìÅ</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">‚≠ê</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">üèÜ</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">üî•</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">üíé</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">üéØ</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">üåü</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">‚ö°</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">üèÄ</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">‚öΩ</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">üéæ</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">üÉè</span>
      </div>
    </div>
    <button class="btn-primary" onclick="createFolder()">Cr√©er le dossier</button>
  </div>
</div>

<!-- ‚ïê‚ïê CROP ‚ïê‚ïê -->
<div class="crop-overlay" id="crop-overlay">
  <div class="crop-label">Ajuste le cadrage</div>
  <div class="crop-wrap"><img id="crop-img" class="crop-img" draggable="false"><div class="crop-frame"></div></div>
  <div class="crop-hint">Glisse pour repositionner</div>
  <div class="crop-actions">
    <button class="crop-btn-a" style="background:var(--surface2);color:var(--text);" onclick="closeCrop()">Annuler</button>
    <button class="crop-btn-a" style="background:var(--accent);color:var(--bg);" onclick="applyCrop()">Appliquer</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê SUPABASE CONFIG ‚ïê‚ïê */
const SB_URL = 'https://tykayvplynkysqwmhkyt.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5a2F5dnBseW5reXNxd21oa3l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MzQxNzYsImV4cCI6MjA4NzQxMDE3Nn0.sbRIHt_qvIBODeLLKS5DWULGmxaghUPYFtBvfFyA85o';
const SB_HDR = { 'Content-Type':'application/json', 'apikey':SB_KEY, 'Authorization':'Bearer '+SB_KEY, 'Prefer':'return=representation' };

async function sbGet(table){
  const r=await fetch(`${SB_URL}/rest/v1/${table}?select=*&order=created_at.desc`,{headers:SB_HDR});
  const d=await r.json();
  if(!r.ok) console.error('sbGet error',table,r.status,d);
  return d;
}
async function sbInsert(table,row){
  const r=await fetch(`${SB_URL}/rest/v1/${table}`,{method:'POST',headers:SB_HDR,body:JSON.stringify(row)});
  const d=await r.json();
  if(!r.ok){ console.error('sbInsert error',table,r.status,JSON.stringify(d)); throw new Error(d?.message||d?.error||JSON.stringify(d)); }
  return d;
}
async function sbUpdate(table,id,patch){
  const r=await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${id}`,{method:'PATCH',headers:SB_HDR,body:JSON.stringify(patch)});
  if(!r.ok){ const d=await r.json(); console.error('sbUpdate error',table,r.status,d); }
}
async function sbDelete(table,id){
  const r=await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${id}`,{method:'DELETE',headers:SB_HDR});
  if(!r.ok){ const d=await r.json(); console.error('sbDelete error',table,r.status,d); }
}

/* Upload image vers Supabase Storage */
async function uploadPhoto(dataUrl, cardId){
  try{
    // Convertir base64 ‚Üí blob
    const res=await fetch(dataUrl);
    const blob=await res.blob();
    const ext=blob.type.includes('png')?'png':'jpg';
    const path=`cards/${cardId}.${ext}`;
    // PUT avec upsert pour √©craser si existe d√©j√†
    const r=await fetch(`${SB_URL}/storage/v1/object/card-photos/${path}`,{
      method:'PUT',
      headers:{
        'apikey':SB_KEY,
        'Authorization':'Bearer '+SB_KEY,
        'Content-Type':blob.type,
        'cache-control':'3600',
        'x-upsert':'true'
      },
      body:blob
    });
    if(!r.ok){
      const err=await r.text();
      console.error('Upload error:',r.status,err);
      throw new Error('upload failed: '+r.status);
    }
    return `${SB_URL}/storage/v1/object/public/card-photos/${path}`;
  }catch(e){
    console.error('Photo upload error:',e);
    return ''; // pas de fallback base64 ‚Äî trop lourd pour Supabase REST
  }
}

/* Normalise un objet carte depuis Supabase (snake_case ‚Üí camelCase) */
function fromSB(c){ return { id:c.id, prenom:c.prenom||'', nom:c.nom||'', club:c.club||'', clubEmoji:c.club_emoji||'', sport:c.sport||'', num:c.num||'', isNum:c.is_num||false, tags:c.tags||[], collection:c.collection||'', notes:c.notes||'', photo:c.photo_url||'', fav:c.fav||false, date:c.date||'' }; }
function toSB(c){ return {
  id: c.id,
  prenom: c.prenom||'',
  nom: c.nom||'',
  club: c.club||'',
  club_emoji: c.clubEmoji||'',
  sport: c.sport||'',
  num: c.num||'',
  is_num: c.isNum||false,
  tags: Array.isArray(c.tags)?c.tags:[],
  collection: c.collection||'',
  notes: c.notes||'',
  photo_url: c.photo||'',
  fav: c.fav||false,
  date: c.date||''
}; }

/* STATE ‚Äî en m√©moire, charg√© depuis Supabase au d√©marrage */
let db = { cards:[], folders:[] };
let curFilter='all', curSearch='', bulkMode=false, bulkSel=[];
let curCardId=null, curFolderId=null;
let eTags={auto:false,patch:false,rookie:false};
let aTags={auto:false,patch:false,rookie:false};
let numOn=false, selClub=null, folderEmoji='üìÅ';
let photoDU=null, cropDU=null;

/* Chargement initial depuis Supabase */
async function loadFromDB(){
  showLoader(true);
  try{
    const [cards, folders] = await Promise.all([ sbGet('cards'), sbGet('folders') ]);
    db.cards = Array.isArray(cards) ? cards.map(fromSB) : [];
    db.folders = Array.isArray(folders) ? folders : [];
    // Trier cartes par date de cr√©ation (plus r√©centes en premier)
    db.cards.sort((a,b) => b.id.localeCompare(a.id));
  }catch(e){ console.error('Load error:',e); showToast('‚ö†Ô∏è Erreur de connexion'); }
  showLoader(false);
  renderHome(); renderCollection(); updateCollSel();
}

function showLoader(on){
  let el=document.getElementById('global-loader');
  if(!el){ el=document.createElement('div'); el.id='global-loader'; el.style.cssText='position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;'; el.innerHTML='<div style="width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;"></div><div style="font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);">Chargement‚Ä¶</div>'; document.body.appendChild(el); }
  el.style.display=on?'flex':'none';
}

/* CLUBS */
const CLUBS=[
  {name:'PSG',emoji:'üîµ',full:'Paris Saint-Germain'},{name:'Real Madrid',emoji:'‚ö™',full:'Real Madrid CF'},{name:'Barcelona',emoji:'üî¥',full:'FC Barcelona'},
  {name:'Man. City',emoji:'üî∑',full:'Manchester City'},{name:'Arsenal',emoji:'‚ù§Ô∏è',full:'Arsenal FC'},{name:'Bayern',emoji:'üî¥',full:'FC Bayern Munich'},
  {name:'Juventus',emoji:'‚¨õ',full:'Juventus FC'},{name:'Chelsea',emoji:'üíô',full:'Chelsea FC'},{name:'Liverpool',emoji:'‚ù§Ô∏è',full:'Liverpool FC'},
  {name:'Inter',emoji:'üîµ',full:'Inter Milan'},{name:'Marseille',emoji:'üîµ',full:'OM'},{name:'Lyon',emoji:'üî¥',full:'OL'},
  {name:'Lakers',emoji:'üíú',full:'Los Angeles Lakers'},{name:'Warriors',emoji:'üíõ',full:'Golden State Warriors'},{name:'Bulls',emoji:'üî¥',full:'Chicago Bulls'},
  {name:'Celtics',emoji:'üíö',full:'Boston Celtics'},{name:'Heat',emoji:'üî¥',full:'Miami Heat'},{name:'Spurs',emoji:'‚¨õ',full:'San Antonio Spurs'},
  {name:'France',emoji:'üá´üá∑',full:'France'},{name:'Espagne',emoji:'üá™üá∏',full:'Espagne'},{name:'USA',emoji:'üá∫üá∏',full:'√âtats-Unis'},{name:'Serbie',emoji:'üá∑üá∏',full:'Serbie'},
];
function showClubGrid(){renderClubGrid(CLUBS);document.getElementById('clubs-grid').style.display='grid';}
function filterClubs(v){const q=v.toLowerCase();renderClubGrid(CLUBS.filter(c=>c.name.toLowerCase().includes(q)||c.full.toLowerCase().includes(q)));document.getElementById('clubs-grid').style.display='grid';}
function renderClubGrid(list){document.getElementById('clubs-grid').innerHTML=list.map(c=>`<div class="club-opt ${selClub&&selClub.name===c.name?'sel':''}" onclick="pickClub('${c.name}')"><div class="club-opt-logo">${c.emoji}</div><div class="club-opt-name">${c.name}</div></div>`).join('');}
function pickClub(n){selClub=CLUBS.find(c=>c.name===n);document.getElementById('f-club-search').value=n;document.getElementById('clubs-grid').style.display='none';const d=document.getElementById('sel-club-disp');d.style.display='flex';d.style.alignItems='center';d.style.gap='8px';d.innerHTML=`<span style="font-size:20px;">${selClub.emoji}</span><span style="font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:14px;text-transform:uppercase;">${selClub.full}</span>`;}

/* PHOTO ‚Äî compress to max 800px / 0.75 quality before stockage */
function handlePhoto(inp){
  const f=inp.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      const MAX=800;
      let w=img.width, h=img.height;
      if(w>h){ if(w>MAX){h=Math.round(h*MAX/w);w=MAX;} } else { if(h>MAX){w=Math.round(w*MAX/h);h=MAX;} }
      const canvas=document.createElement('canvas');
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      photoDU=canvas.toDataURL('image/jpeg',0.75);
      document.getElementById('photo-preview-img').src=photoDU;
      document.getElementById('photo-preview-wrap').style.display='block';
      document.getElementById('photo-placeholder-ui').style.display='none';
      document.getElementById('crop-btn').style.display='block';
    };
    img.src=e.target.result;
  };
  r.readAsDataURL(f);
}

/* CROP */
let cDrag=null,cOX=0,cOY=0;
function openCrop(){if(!photoDU)return;const img=document.getElementById('crop-img');img.src=photoDU;cOX=0;cOY=0;img.style.transform='translate(0,0)';document.getElementById('crop-overlay').classList.add('open');img.onmousedown=img.ontouchstart=e=>{e.preventDefault();const p=e.touches?e.touches[0]:e;cDrag={x:p.clientX-cOX,y:p.clientY-cOY};};document.onmousemove=document.ontouchmove=e=>{if(!cDrag)return;const p=e.touches?e.touches[0]:e;cOX=p.clientX-cDrag.x;cOY=p.clientY-cDrag.y;img.style.transform=`translate(${cOX}px,${cOY}px)`;};document.onmouseup=document.ontouchend=()=>cDrag=null;}
function closeCrop(){document.getElementById('crop-overlay').classList.remove('open');}
function applyCrop(){cropDU=photoDU;closeCrop();showToast('‚úÇÔ∏è Recadrage appliqu√©');}

/* NAV */
function navigate(p){document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));document.getElementById('page-'+p).classList.add('active');document.getElementById('tab-'+p).classList.add('active');if(p==='collection')renderCollection();if(p==='home')renderHome();}

/* TOGGLES */
function toggleNum(v){numOn=v;document.getElementById('num-oui').classList.toggle('on',v);document.getElementById('num-non').classList.toggle('on',!v);document.getElementById('f-num').style.display=v?'block':'none';}
toggleNum(false);
function toggleTag(t){aTags[t]=!aTags[t];document.getElementById('tog-'+t).classList.toggle('on',aTags[t]);}
function eTogTag(t){eTags[t]=!eTags[t];document.getElementById('e-tog-'+t).classList.toggle('on',eTags[t]);}

/* SAVE CARD */
async function saveCard(){
  const prenom=document.getElementById('f-prenom').value.trim(), nom=document.getElementById('f-nom').value.trim();
  if(!prenom&&!nom){ showToast('‚ö†Ô∏è Saisis au moins un nom'); return; }

  // Bloquer le bouton pendant la sauvegarde
  const btn=document.querySelector('#page-scanner .btn-primary');
  btn.disabled=true; btn.textContent='‚è≥ Enregistrement‚Ä¶';

  try{
    let coll=document.getElementById('f-collection').value;
    if(coll==='__new__'){
      const nn=document.getElementById('f-new-coll').value.trim();
      if(nn){ await createFolderNamed(nn); coll=nn; } else coll='';
    }

    const id=Date.now()+'';
    const rawPhoto=cropDU||photoDU||'';

    // Upload photo en premier
    let photoUrl='';
    if(rawPhoto){
      btn.textContent='üì§ Upload photo‚Ä¶';
      photoUrl=await uploadPhoto(rawPhoto, id);
      if(!photoUrl) showToast('‚ö†Ô∏è Photo non sauvegard√©e ‚Äî bucket manquant ?');
    }

    const card={
      id, prenom, nom,
      club: selClub?selClub.name:document.getElementById('f-club-search').value.trim(),
      clubEmoji: selClub?selClub.emoji:'',
      sport: document.getElementById('f-sport').value,
      num: numOn?document.getElementById('f-num').value.trim():'',
      isNum: numOn,
      tags: Object.keys(aTags).filter(k=>aTags[k]),
      collection: coll,
      notes: document.getElementById('f-notes').value.trim(),
      photo: photoUrl,
      fav: false,
      date: new Date().toLocaleDateString('fr-FR')
    };

    btn.textContent='üíæ Sauvegarde‚Ä¶';
    const result=await sbInsert('cards', toSB(card));
    if(result?.error) throw new Error(result.error.message);

    db.cards.unshift(card);
    resetForm();
    showToast('‚úÖ Carte enregistr√©e !');
    navigate('home');
  }catch(e){
    console.error('saveCard error:',e);
    showToast('‚ö†Ô∏è Erreur : '+e.message);
  }finally{
    btn.disabled=false; btn.textContent='Enregistrer la carte';
  }
}
function resetForm(){['f-prenom','f-nom','f-club-search','f-notes','f-num'].forEach(id=>document.getElementById(id).value='');document.getElementById('f-sport').value='';document.getElementById('photo-preview-wrap').style.display='none';document.getElementById('photo-placeholder-ui').style.display='';document.getElementById('crop-btn').style.display='none';photoDU=null;cropDU=null;selClub=null;aTags={auto:false,patch:false,rookie:false};['tog-auto','tog-patch','tog-rookie'].forEach(id=>document.getElementById(id).classList.remove('on'));toggleNum(false);document.getElementById('sel-club-disp').style.display='none';document.getElementById('clubs-grid').style.display='none';document.getElementById('new-coll-wrap').style.display='none';updateCollSel();}
function updateCollSel(){const s=document.getElementById('f-collection');s.innerHTML='<option value="">Sans collection</option>'+db.folders.map(f=>`<option value="${f.name}">${f.emoji} ${f.name}</option>`).join('')+'<option value="__new__">+ Cr√©er une nouvelle‚Ä¶</option>';s.onchange=function(){document.getElementById('new-coll-wrap').style.display=this.value==='__new__'?'block':'none';};}
updateCollSel();

/* HOME */
function renderHome(){const t=db.cards.length;document.getElementById('home-count').textContent=`${t} carte${t>1?'s':''}`;renderFavs();renderRecent(db.cards);}
function renderFavs(){
  const favs=db.cards.filter(c=>c.fav);document.getElementById('favs-count').textContent=favs.length;
  const el=document.getElementById('favs-container');
  if(!favs.length){el.innerHTML='<div class="fav-empty">Aucun favori ¬∑ marque des cartes avec ‚≠ê</div>';return;}
  el.innerHTML=favs.map(c=>`
    <div class="fav-card" onclick="openCard('${c.id}')">
      <div class="fav-card-img">
        ${c.photo?`<img src="${c.photo}" alt="">`:`<div class="fav-card-img-empty">${c.clubEmoji||'üÉè'}</div>`}
        <div class="fav-card-top">
          ${c.isNum&&c.num?`<div class="fav-rating">${c.num.replace('/','').substring(0,3)}</div>`:'<div class="fav-rating-empty"></div>'}
          <div class="fav-badges-top">
            ${c.tags.includes('auto')?'<span class="badge auto">Auto</span>':''}
            ${c.tags.includes('patch')?'<span class="badge patch">Patch</span>':''}
            ${c.tags.includes('rookie')?'<span class="badge rookie">RC</span>':''}
          </div>
        </div>
      </div>
      <div class="fav-card-bot"><div class="fav-card-name">${c.prenom}<br>${c.nom}</div><div class="fav-card-club">${c.clubEmoji||''} ${c.club||'‚Äî'}</div></div>
    </div>`).join('');
}
function renderRecent(cards){
  const el=document.getElementById('recent-list');
  if(!cards.length){el.innerHTML='<div class="empty-state"><div class="empty-icon">üÉè</div><div class="empty-title">Aucune carte</div><div class="empty-sub">Appuie sur le scanner pour commencer</div></div>';return;}
  el.innerHTML=cards.slice(0,25).map(c=>`
    <div class="card-item" onclick="openCard('${c.id}')">
      <div class="card-sport-bar ${c.sport||''}"></div>
      <div class="card-thumb">${c.photo?`<img src="${c.photo}" alt="">`:`<span>${c.clubEmoji||'üÉè'}</span>`}</div>
      <div class="card-info">
        <div class="card-first">${c.prenom}</div>
        <div class="card-last">${c.nom}</div>
        <div class="card-club-row">${c.clubEmoji?`<span>${c.clubEmoji}</span>`:''}<span>${c.club||'‚Äî'}</span>${c.sport?`<span style="opacity:.35;">¬∑</span><span>${sportL(c.sport)}</span>`:''}</div>
        <div class="card-badges-row">${c.tags.includes('auto')?'<span class="badge auto">Auto</span>':''}${c.tags.includes('patch')?'<span class="badge patch">Patch</span>':''}${c.tags.includes('rookie')?'<span class="badge rookie">RC</span>':''}${c.isNum&&c.num?`<span class="badge num">${c.num}</span>`:''}</div>
      </div>
      <div class="card-right"><div class="card-date">${c.date}</div><div class="card-sport-ico">${sportI(c.sport)}</div></div>
    </div>`).join('');
}
function homeSearch(v){if(!v.trim()){renderRecent(db.cards);return;}const q=v.toLowerCase();renderRecent(db.cards.filter(c=>`${c.prenom} ${c.nom} ${c.club}`.toLowerCase().includes(q)));}
function sportL(s){return{football:'Football',basketball:'Basketball',tennis:'Tennis',baseball:'Baseball',hockey:'Hockey'}[s]||s;}
function sportI(s){return{football:'‚öΩ',basketball:'üèÄ',tennis:'üéæ',baseball:'‚öæ',hockey:'üèí'}[s]||'';}

/* COLLECTION */
function renderCollection(){document.getElementById('coll-grid').classList.toggle('bulk-mode',bulkMode);renderFolders();renderCG2(getFiltered());}
function getFiltered(){let c=[...db.cards];if(curFilter!=='all'){if(['auto','patch','rookie'].includes(curFilter))c=c.filter(x=>x.tags.includes(curFilter));else if(curFilter==='num')c=c.filter(x=>x.isNum);else c=c.filter(x=>x.sport===curFilter);}if(curSearch){const q=curSearch.toLowerCase();c=c.filter(x=>`${x.prenom} ${x.nom} ${x.club}`.toLowerCase().includes(q));}return c;}
function setFilter(f,el){curFilter=f;document.querySelectorAll('.filter-tag').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderCG2(getFiltered());}
function collSearch(v){curSearch=v;renderCG2(getFiltered());}
function renderFolders(){const g=document.getElementById('folders-grid');g.innerHTML=db.folders.map(f=>{const n=db.cards.filter(c=>c.collection===f.name).length;return`<div class="folder-card" onclick="openFolder('${f.id}')"><div class="folder-top"><div class="folder-emoji">${f.emoji}</div><div class="folder-n">${n}</div></div><div class="folder-name">${f.name}</div><div class="folder-sub">carte${n>1?'s':''}</div></div>`}).join('')+`<div class="folder-card folder-add" onclick="openNewFolder()"><span style="font-size:20px;">üìÅ</span><span>Nouveau</span></div>`;const bd=document.getElementById('bulk-dest');bd.innerHTML='<option value="">D√©placer vers‚Ä¶</option>'+db.folders.map(f=>`<option value="${f.name}">${f.emoji} ${f.name}</option>`).join('');}
function renderCG2(cards){const g=document.getElementById('coll-grid'),em=document.getElementById('coll-empty');if(!cards.length){g.innerHTML='';em.style.display='block';return;}em.style.display='none';g.innerHTML=cards.map(c=>`<div class="coll-thumb" onclick="handleThumb('${c.id}')">${c.photo?`<img src="${c.photo}" alt="">`:`<div class="coll-thumb-empty">${c.clubEmoji||'üÉè'}</div>`}<div class="bulk-check ${bulkSel.includes(c.id)?'checked':''}" id="bc-${c.id}">${bulkSel.includes(c.id)?'<svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="var(--bg)" stroke-width="3.5"><polyline points="20 6 9 17 4 12"/></svg>':''}</div></div>`).join('');}
function handleThumb(id){if(bulkMode){if(bulkSel.includes(id))bulkSel=bulkSel.filter(x=>x!==id);else bulkSel.push(id);renderCG2(getFiltered());}else openCard(id);}

/* BULK */
function toggleBulk(){bulkMode=!bulkMode;bulkSel=[];document.getElementById('bulk-bar').classList.toggle('show',bulkMode);renderCollection();}
function cancelBulk(){bulkMode=false;bulkSel=[];document.getElementById('bulk-bar').classList.remove('show');renderCollection();}
async function executeBulk(){
  const d=document.getElementById('bulk-dest').value;
  if(!bulkSel.length){showToast('‚ö†Ô∏è Aucune carte s√©lectionn√©e');return;}
  await Promise.all(bulkSel.map(id=>sbUpdate('cards',id,{collection:d})));
  db.cards.forEach(c=>{if(bulkSel.includes(c.id))c.collection=d;});
  cancelBulk();renderCollection();showToast(`‚úÖ ${bulkSel.length} carte(s) d√©plac√©e(s)`);
}

/* FOLDERS */
function openNewFolder(){document.getElementById('new-folder-name').value='';folderEmoji='üìÅ';document.getElementById('folder-sheet').classList.add('open');}
function selEmoji(el){folderEmoji=el.textContent;}
async function createFolderNamed(name){
  if(db.folders.find(f=>f.name===name))return;
  const f={id:Date.now()+'',name,emoji:folderEmoji||'üìÅ'};
  await sbInsert('folders',f); db.folders.push(f);
}
async function createFolder(){
  const n=document.getElementById('new-folder-name').value.trim();
  if(!n){showToast('‚ö†Ô∏è Saisis un nom');return;}
  const f={id:Date.now()+'',name:n,emoji:folderEmoji};
  try{
    await sbInsert('folders',f);
    db.folders.push(f);
    document.getElementById('folder-sheet').classList.remove('open');
    renderCollection();updateCollSel();showToast('üìÅ Dossier cr√©√© !');
  }catch(e){showToast('‚ö†Ô∏è Erreur');}
}
function openFolder(fid){const f=db.folders.find(x=>x.id===fid);if(!f)return;curFolderId=fid;document.getElementById('coll-view-title').textContent=f.emoji+' '+f.name;const cards=db.cards.filter(c=>c.collection===f.name);document.getElementById('folder-cards-grid').innerHTML=cards.map(c=>`<div class="coll-thumb" onclick="openCard('${c.id}')">${c.photo?`<img src="${c.photo}" alt="">`:`<div class="coll-thumb-empty">${c.clubEmoji||'üÉè'}</div>`}</div>`).join('')||'<div class="empty-state"><div class="empty-icon">üÉè</div><div class="empty-title">Dossier vide</div></div>';document.getElementById('coll-view').classList.add('open');}
function closeCollView(){document.getElementById('coll-view').classList.remove('open');}
async function deleteCurrentFolder(){
  const f=db.folders.find(x=>x.id===curFolderId);if(!f)return;
  if(!confirm(`Supprimer "${f.name}" ?`))return;
  await sbDelete('folders',curFolderId);
  await Promise.all(db.cards.filter(c=>c.collection===f.name).map(c=>sbUpdate('cards',c.id,{collection:''})));
  db.folders=db.folders.filter(x=>x.id!==curFolderId);
  db.cards.forEach(c=>{if(c.collection===f.name)c.collection='';});
  closeCollView();renderCollection();showToast('üóëÔ∏è Supprim√©');
}

/* CARD DETAIL */
function openCard(id){
  const c=db.cards.find(x=>x.id===id);if(!c)return;curCardId=id;

  // Watermark background ‚Äî photo si dispo, sinon nom texte
  const bgEl=document.getElementById('card-bg-name');
  if(c.photo){
    bgEl.innerHTML='';
    bgEl.style.backgroundImage=`url(${c.photo})`;
    bgEl.style.backgroundSize='cover';
    bgEl.style.backgroundPosition='center top';
    bgEl.style.opacity='0.12';
    bgEl.style.filter='blur(4px) saturate(0)';
    bgEl.style.transform='scale(1.08)';
  } else {
    bgEl.innerHTML=c.nom||'';
    bgEl.style.backgroundImage='none';
    bgEl.style.opacity='1';
    bgEl.style.filter='none';
    bgEl.style.transform='none';
  }

  // 3D card content
  const cont=document.getElementById('card-3d-content');
  if(c.photo){
    cont.innerHTML=`<img src="${c.photo}" alt="" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0;">`;
    cont.className='';
  } else {
    cont.className='card-3d-placeholder';
    cont.innerHTML=`<span style="font-size:40px;opacity:.25;">üÉè</span><span style="font-size:10px;color:var(--text-dim);font-weight:300;letter-spacing:.5px;text-transform:uppercase;">Aucune photo</span>`;
  }
  document.getElementById('detail-prenom').textContent=c.prenom||'';
  document.getElementById('detail-nom').textContent=(c.nom||'‚Äî').toUpperCase();
  document.getElementById('detail-club-e').textContent=c.clubEmoji||'';
  document.getElementById('detail-club-n').textContent=c.club||'‚Äî';
  const sep=document.getElementById('detail-sep'),sl=document.getElementById('detail-sport-label');
  if(c.sport){sep.style.display='';sl.textContent=sportL(c.sport);}else{sep.style.display='none';sl.textContent='';}
  const fb=document.getElementById('detail-fav-btn');fb.textContent=c.fav?'‚≠ê':'‚òÜ';fb.style.color=c.fav?'var(--gold)':'';
  const nb=document.getElementById('detail-num');if(c.isNum&&c.num){nb.style.display='';nb.textContent='üî¢ '+c.num;}else nb.style.display='none';
  document.getElementById('detail-badges').innerHTML=(c.tags.includes('auto')?'<span class="badge auto">Auto</span>':'')+(c.tags.includes('patch')?'<span class="badge patch">Patch</span>':'')+(c.tags.includes('rookie')?'<span class="badge rookie">Rookie</span>':'');
  document.getElementById('d-coll').textContent=c.collection||'Aucune';
  document.getElementById('d-num').textContent=c.isNum?(c.num||'Oui'):'Non';
  document.getElementById('d-sport').textContent=(sportI(c.sport)||'‚Äî')+' '+(sportL(c.sport)||'‚Äî');
  document.getElementById('d-date').textContent=c.date;
  if(c.notes){document.getElementById('d-notes-wrap').style.display='';document.getElementById('d-notes-val').textContent=c.notes;}else document.getElementById('d-notes-wrap').style.display='none';
  document.getElementById('card-detail').classList.add('open');
  initGyro();
}
function closeDetail(){document.getElementById('card-detail').classList.remove('open');stopGyro();}

/* GYRO */
let gyroH=null,gBeta=null,gGamma=null,tRX=0,tRY=0,cRX=0,cRY=0,raf=null;
function initGyro(){
  const scene=document.getElementById('card-3d-scene');
  if(raf)cancelAnimationFrame(raf);
  tRX=0;tRY=0;cRX=0;cRY=0;
  function loop(){cRX+=(tRX-cRX)*.10;cRY+=(tRY-cRY)*.10;const card=document.getElementById('card-3d');if(card){card.style.transform=`rotateX(${cRX}deg) rotateY(${cRY}deg)`;if(Math.abs(cRX)>1||Math.abs(cRY)>1)card.classList.add('tilting');else card.classList.remove('tilting');}raf=requestAnimationFrame(loop);}
  loop();
  scene.onmousemove=e=>{const r=scene.getBoundingClientRect();tRX=((e.clientY-r.top-r.height/2)/r.height)*-28;tRY=((e.clientX-r.left-r.width/2)/r.width)*28;};
  scene.onmouseleave=()=>{tRX=0;tRY=0;};
  scene.addEventListener('touchmove',e=>{const t=e.touches[0],r=scene.getBoundingClientRect();tRX=((t.clientY-r.top-r.height/2)/r.height)*-28;tRY=((t.clientX-r.left-r.width/2)/r.width)*28;e.preventDefault();},{passive:false});
  scene.addEventListener('touchend',()=>{tRX=0;tRY=0;});
  if(typeof DeviceOrientationEvent!=='undefined'){if(typeof DeviceOrientationEvent.requestPermission==='function')showGyroBtn();else startGyro();}
}
function showGyroBtn(){
  const scene=document.getElementById('card-3d-scene');
  if(scene.querySelector('.gyro-btn'))return;
  const btn=document.createElement('button');btn.className='gyro-btn';btn.textContent='üì± Activer le gyroscope';
  btn.addEventListener('click',async()=>{
    try{const p=await DeviceOrientationEvent.requestPermission();if(p==='granted'){startGyro();btn.textContent='‚úÖ Actif';btn.style.color='#6ee7b7';setTimeout(()=>btn.remove(),1200);}else{btn.textContent='‚õî Refus√©';setTimeout(()=>btn.remove(),1800);}}
    catch(e){btn.textContent='‚ö†Ô∏è '+e.message;setTimeout(()=>btn.remove(),2000);}
  });
  scene.appendChild(btn);
}
function startGyro(){gBeta=null;gGamma=null;let n=0;gyroH=e=>{if(e.beta===null||e.gamma===null)return;if(n<4){gBeta=gBeta===null?e.beta:(gBeta+e.beta)/2;gGamma=gGamma===null?e.gamma:(gGamma+e.gamma)/2;n++;return;}tRX=Math.max(-30,Math.min(30,(e.beta-gBeta)))*-0.7;tRY=Math.max(-30,Math.min(30,(e.gamma-gGamma)))*0.7;};window.addEventListener('deviceorientation',gyroH,true);}
function stopGyro(){if(gyroH){window.removeEventListener('deviceorientation',gyroH,true);gyroH=null;}if(raf){cancelAnimationFrame(raf);raf=null;}tRX=0;tRY=0;cRX=0;cRY=0;const card=document.getElementById('card-3d');if(card){card.style.transform='';card.classList.remove('tilting');}const scene=document.getElementById('card-3d-scene');if(scene){scene.onmousemove=null;scene.onmouseleave=null;}}

/* FAV */
async function toggleFav(){
  const c=db.cards.find(x=>x.id===curCardId);if(!c)return;
  c.fav=!c.fav;
  await sbUpdate('cards',c.id,{fav:c.fav});
  const b=document.getElementById('detail-fav-btn');
  b.textContent=c.fav?'‚≠ê':'‚òÜ';b.style.color=c.fav?'var(--gold)':'';
  showToast(c.fav?'‚≠ê Ajout√© aux favoris':'‚ú© Retir√© des favoris');
}

/* EDIT */
function editCurrentCard(){const c=db.cards.find(x=>x.id===curCardId);if(!c)return;document.getElementById('e-prenom').value=c.prenom;document.getElementById('e-nom').value=c.nom;document.getElementById('e-club').value=c.club;document.getElementById('e-sport').value=c.sport;document.getElementById('e-num').value=c.num||'';document.getElementById('e-notes').value=c.notes;eTags={auto:c.tags.includes('auto'),patch:c.tags.includes('patch'),rookie:c.tags.includes('rookie')};['auto','patch','rookie'].forEach(t=>document.getElementById('e-tog-'+t).classList.toggle('on',eTags[t]));const s=document.getElementById('e-collection');s.innerHTML='<option value="">Sans collection</option>'+db.folders.map(f=>`<option value="${f.name}" ${c.collection===f.name?'selected':''}>${f.emoji} ${f.name}</option>`).join('');document.getElementById('edit-sheet').classList.add('open');}
async function saveEdit(){
  const c=db.cards.find(x=>x.id===curCardId);if(!c)return;
  c.prenom=document.getElementById('e-prenom').value.trim();
  c.nom=document.getElementById('e-nom').value.trim();
  c.club=document.getElementById('e-club').value.trim();
  c.sport=document.getElementById('e-sport').value;
  c.num=document.getElementById('e-num').value.trim();
  c.isNum=!!c.num;
  c.tags=Object.keys(eTags).filter(k=>eTags[k]);
  c.notes=document.getElementById('e-notes').value.trim();
  c.collection=document.getElementById('e-collection').value;
  await sbUpdate('cards',c.id,toSB(c));
  closeSheet('edit-sheet',{target:null});openCard(curCardId);showToast('‚úÖ Carte modifi√©e !');
}
function closeSheet(id,e){if(!e||e.target===document.getElementById(id))document.getElementById(id).classList.remove('open');}

/* PLAYER AI ‚Äî 1 seule recherche Wikipedia */
function openPlayerAI(){
  const c=db.cards.find(x=>x.id===curCardId);if(!c)return;
  document.getElementById('player-ai-content').innerHTML=`
    <div class="ai-loading">
      <div class="ai-spin"></div>
      <div style="font-size:11px;letter-spacing:.8px;text-transform:uppercase;">Wikipedia‚Ä¶</div>
    </div>`;
  document.getElementById('player-sheet').classList.add('open');
  fetchPlayer(c);
}

async function fetchPlayer(card){
  const name=`${card.prenom} ${card.nom}`;
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1500,
        tools:[{type:'web_search_20250305',name:'web_search'}],
        tool_choice:{type:'any'},
        messages:[{
          role:'user',
          content:`Cherche "${name} wikipedia ${card.sport||''}" en UNE seule recherche, puis r√©ponds UNIQUEMENT en JSON valide (sans backticks):
{"nom":"Pr√©nom Nom","nationalite":"France","clubActuel":"Club","clubEmoji":"üèÖ","poste":"Attaquant","description":"1-2 phrases biographiques.","naissance":"01/01/1990","taille":"1m80","statsCurrentSeason":{"val1":20,"val2":12,"val3":30,"label1":"Buts","label2":"Passes","label3":"Matchs"},"statsSaisons":[{"saison":"2021-22","val":18},{"saison":"2022-23","val":22},{"saison":"2023-24","val":25},{"saison":"2024-25","val":20}],"statLabel":"Buts","historique":[{"club":"Club","emoji":"üèüÔ∏è","annees":"2018-2022"}],"source":"Wikipedia"}`
        }]
      })
    });
    const d=await r.json();
    const text=(d.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('');
    const m=text.match(/\{[\s\S]*\}/);
    if(!m) throw new Error('no json');
    renderAI(JSON.parse(m[0]),card);
  }catch(e){
    renderAI(mockPlayer(card),card);
  }
}
function mockPlayer(c){return{nom:`${c.prenom} ${c.nom}`,nationalite:'France',clubActuel:c.club||'‚Äî',clubEmoji:c.clubEmoji||'üèÖ',poste:'Joueur',description:'Joueur talentueux reconnu pour son niveau de jeu exceptionnel.',statsCurrentSeason:{val1:18,val2:9,val3:24,label1:'Buts',label2:'Passes',label3:'Matchs'},statsSaisons:[{saison:'2021-22',val:14},{saison:'2022-23',val:20},{saison:'2023-24',val:22},{saison:'2024-25',val:18}],statLabel:'Buts',historique:[{club:'Club Formateur',emoji:'üèüÔ∏è',annees:'2018-2021'},{club:c.club||'Club Pro',emoji:c.clubEmoji||'‚öΩ',annees:'2021-pr√©sent'}]};}
function renderAI(p,card){
  const mx=Math.max(...p.statsSaisons.map(s=>s.val),1);
  const bars=p.statsSaisons.map((s,i)=>{
    const isC=i===p.statsSaisons.length-1;
    const h=Math.round((s.val/mx)*56);
    return`<div class="ai-bar${isC?' cur':''}" style="height:${h}px"><div class="ai-bar-v">${s.val}</div><div class="ai-bar-y">${s.saison.slice(-5)}</div></div>`;
  }).join('');

  const sourceTag=p.source==='Wikipedia'
    ? `<div style="display:inline-flex;align-items:center;gap:5px;background:var(--surface2);border:1px solid var(--border2);border-radius:4px;padding:3px 9px;font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;margin-bottom:14px;">üåê Source : Wikipedia</div>`
    : `<div style="display:inline-flex;align-items:center;gap:5px;background:var(--surface2);border:1px solid var(--border2);border-radius:4px;padding:3px 9px;font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--text-dim);margin-bottom:14px;">‚ö†Ô∏è Donn√©es IA ¬∑ non officielles</div>`;

  const bioExtra=(p.naissance||p.taille)?`
    <div style="display:flex;gap:7px;margin-bottom:14px;">
      ${p.naissance?`<div style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:9px;text-align:center;"><div style="font-size:9px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);margin-bottom:3px;">Naissance</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;">${p.naissance}</div></div>`:''}
      ${p.taille?`<div style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:9px;text-align:center;"><div style="font-size:9px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);margin-bottom:3px;">Taille</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;">${p.taille}</div></div>`:''}
    </div>`:''

  document.getElementById('player-ai-content').innerHTML=`
    <div class="ai-hdr">
      <div class="ai-avatar">${p.clubEmoji}</div>
      <div><div class="ai-name">${p.nom}</div><div class="ai-sub">${p.poste} ¬∑ ${p.nationalite}</div></div>
    </div>
    ${sourceTag}
    <div class="ai-desc">${p.description}</div>
    ${bioExtra}
    <div class="ai-sec">
      <div class="ai-sec-title">Saison en cours</div>
      <div class="ai-stats">
        <div class="ai-stat"><div class="ai-stat-label">${p.statsCurrentSeason.label1}</div><div class="ai-stat-val">${p.statsCurrentSeason.val1}</div></div>
        <div class="ai-stat"><div class="ai-stat-label">${p.statsCurrentSeason.label2}</div><div class="ai-stat-val">${p.statsCurrentSeason.val2}</div></div>
        <div class="ai-stat"><div class="ai-stat-label">${p.statsCurrentSeason.label3}</div><div class="ai-stat-val">${p.statsCurrentSeason.val3}</div></div>
      </div>
    </div>
    <div class="ai-sec">
      <div class="ai-sec-title">${p.statLabel} par saison</div>
      <div class="ai-chart" style="margin-bottom:22px;">${bars}</div>
    </div>
    <div class="ai-sec">
      <div class="ai-sec-title">Historique de clubs</div>
      <div class="ai-clubs">${p.historique.map(h=>`
        <div class="ai-club-row">
          <div class="ai-club-e">${h.emoji}</div>
          <div><div class="ai-club-n">${h.club}</div><div class="ai-club-y">${h.annees}</div></div>
        </div>`).join('')}
      </div>
    </div>`;
}

/* TOAST */
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

/* INIT ‚Äî charge depuis Supabase */
loadFromDB();
</script>
</body>
</html>
