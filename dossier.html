<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;600;700;800;900&family=Barlow:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800&family=Fugaz+One&display=swap" rel="stylesheet">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CardVault">
<meta name="theme-color" content="#0c0c0e">
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAMAEBAAAAEAIABoBAAANgAAAICAgAAABACAAoAkAAMYAAAA=">
<link rel="stylesheet" href="assets/app.css">
<title>CardVault ‚Äî Dossier</title>
<style>
.view{ display:block!important; position:relative; min-height:100vh; }
body{ overflow-y:auto; }
.dossier-hero{ padding:22px 20px 0; }
.dossier-back{ background:none;border:none;color:var(--text);font-size:22px;cursor:pointer;padding:0;margin-bottom:16px;display:flex;align-items:center;gap:6px; }
.dossier-meta{ display:flex;align-items:center;gap:10px;margin-bottom:4px; }
.dossier-emoji{ font-size:32px; }
.dossier-title{ font-family:"Barlow Condensed",sans-serif;font-size:42px;font-weight:900;text-transform:uppercase;color:var(--accent);line-height:1; }
.dossier-count{ font-size:13px;color:var(--text-dim);margin-bottom:18px; }
.dossier-filters{ padding:0 20px 14px; }
.dossier-cards{ padding:0 12px 40px; }
</style>
</head>
<body>

<!-- Fullscreen image viewer -->
<div id="img-viewer" class="img-viewer" style="display:none" aria-hidden="true">
  <button id="img-viewer-close" class="img-viewer-close" aria-label="Fermer"></button>
  <img id="img-viewer-img" alt="Carte" />
</div>

<section class="view" id="view-dossier">
  <div class="dossier-hero">
    <button class="dossier-back" onclick="navBack()">‚Üê</button>
    <div class="dossier-meta">
      <div class="dossier-emoji" id="dossier-emoji">üìÅ</div>
      <div class="dossier-title" id="dossier-title">‚Äî</div>
    </div>
    <div class="dossier-count" id="dossier-count"></div>
  </div>

  <div class="dossier-filters">
    <!-- Brands -->
    <div class="filters-row" id="d-brand-row" style="padding-bottom:4px;gap:8px;"></div>
    <!-- Specs -->
    <div class="filters-row" id="d-spec-row" style="padding-top:6px;gap:8px;">
      <div class="filter-tag type-filter active" onclick="setDossierSpec('all',this)">Tout</div>
      <div class="filter-tag type-filter" onclick="setDossierSpec('auto',this)">Auto</div>
      <div class="filter-tag type-filter" onclick="setDossierSpec('patch',this)">Patch</div>
      <div class="filter-tag type-filter" onclick="setDossierSpec('rookie',this)">Rookie</div>
      <div class="filter-tag type-filter" onclick="setDossierSpec('num',this)">Num√©rot√©e</div>
    </div>
  </div>

  <div class="dossier-cards">
    <div class="colls-grid" id="dossier-grid"></div>
    <div id="dossier-empty" class="empty-state" style="display:none;">
      <div class="empty-icon"></div>
      <div class="empty-title">Aucune carte</div>
      <div class="empty-sub">Ce dossier est vide</div>
    </div>
  </div>
</section>

<!-- CARD DETAIL (reused from collection) -->
<div class="card-detail" id="card-detail">
  <div class="card-detail-hdr">
    <button class="back-btn" onclick="closeDetail()"><svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
    <div style="display:flex;gap:8px;">
      <button class="detail-fav-btn" id="detail-fav-btn" onclick="toggleFav()"></button>
    </div>
  </div>
  <div class="card-3d-scene card-animated" id="card-3d-scene">
    <div class="card-bg-name-text" id="card-bg-name-text" style="display:none;"></div>
    <div class="card-flip-container" id="card-flip-container">
      <div class="card-flip-inner" id="card-flip-inner">
        <div class="card-face" id="card-face-front">
          <div class="card-3d-content card-3d-placeholder" id="card-3d-content"><span style="font-size:40px;opacity:.25;">üÉè</span></div>
        </div>
        <div class="card-face card-face-back" id="card-face-back">
          <div class="card-3d-content card-3d-placeholder" id="card-3d-content-back"><span style="font-size:40px;opacity:.25;"></span></div>
        </div>
      </div>
    </div>
    <button class="flip-btn" id="flip-btn" onclick="flipCard()" style="display:none;" title="Retourner la carte"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg></button>
  </div>
  <div class="card-detail-bottom">
    <div class="player-identity">
      <div>
        <div class="player-first" id="detail-prenom"></div>
        <div class="player-last" id="detail-nom" onclick="openPlayer(curCardId)" style="cursor:pointer;">‚Äî</div>
        <div class="player-meta">
          <span id="detail-flag" class="player-flag" style="display:none;"></span>
          <span id="detail-club-logo-wrap" onclick="openClub(db.cards.find(x=>String(x.id)===String(curCardId))?.club||'')" style="cursor:pointer;"></span>
          <span class="player-club" id="detail-club-n" onclick="openClub(db.cards.find(x=>String(x.id)===String(curCardId))?.club||'')" style="cursor:pointer;"></span>
          <span class="sep" id="detail-sep" style="display:none;"></span>
          <span class="player-sport-label" id="detail-sport-label" onclick="openSport(db.cards.find(x=>String(x.id)===String(curCardId))?.sport||'')" style="cursor:pointer;"></span>
        </div>
      </div>
      <div class="player-right" style="display:none;"><div id="detail-num" style="display:none;"></div><div id="detail-badges"></div></div>
    </div>
    <div class="chips-grid" id="chips-grid">
      <div class="chip chip-marque"><div class="chip-label">Marque</div><div class="chip-val" id="d-marque">‚Äî</div></div>
      <div class="chip"><div class="chip-label">Ann√©e</div><div class="chip-val" id="d-annee">‚Äî</div></div>
      <div class="chip"><div class="chip-label">Set</div><div class="chip-val" id="d-set" style="font-size:13px;">‚Äî</div></div>
      <div class="chip" id="chip-tags-row"><div class="chip-label">Sp√©cificit√©s</div><div class="chip-val" id="d-tags-val" style="display:flex;gap:4px;flex-wrap:wrap;align-items:center;padding-top:2px;font-size:12px;">‚Äî</div></div>
      <div class="chip"><div class="chip-label">Dossier</div><div class="chip-val" id="d-coll">‚Äî</div></div>
      <div class="chip"><div class="chip-label">Prix</div><div class="chip-val price-val" id="d-price">‚Äî</div></div>
    </div>
    <div class="detail-actions">
      <button class="btn-secondary" style="flex:1;" onclick="editCurrentCard()">Modifier</button>
    </div>
  </div>
</div>

<!-- EDIT SHEET -->
<div class="sheet-overlay" id="edit-sheet" onclick="closeSheet('edit-sheet',event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Modifier</div>
    <button class="sheet-delete-btn" onclick="deleteCurrentCard()">Supprimer</button>
    <div class="side-tabs">
      <div class="side-tab active" id="edit-tab-recto" onclick="switchEditSide('recto')">Recto</div>
      <div class="side-tab" id="edit-tab-verso" onclick="switchEditSide('verso')">Verso</div>
    </div>
    <div id="edit-recto-zone" style="margin-bottom:10px;">
      <div class="photo-upload" id="edit-photo-zone" style="max-height:180px;">
        <input type="file" id="e-photo-lib" accept="image/*" style="display:none" onchange="handleEditPhoto(this,'recto')">
        <div id="e-preview-wrap" style="display:none;position:absolute;inset:0;" onclick="document.getElementById('e-photo-lib').click()">
          <img id="e-preview-img" style="width:100%;height:100%;object-fit:cover;">
          <div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.6);border-radius:99px;padding:3px 10px;font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">Changer</div>
        </div>
        <div id="e-placeholder"><div style="font-size:22px;"></div>
          <div class="photo-btns">
            <button class="photo-btn" type="button" onclick="document.getElementById('e-photo-lib').click()">Biblioth√®que</button>
          </div>
        </div>
      </div>
      <button class="crop-btn" id="e-crop-btn" style="display:none;margin-bottom:8px;" onclick="openCrop('edit-recto')">Recadrer</button>
    </div>
    <div id="edit-verso-zone" style="display:none;margin-bottom:10px;">
      <div class="photo-upload" id="edit-photo-zone-v" style="max-height:180px;">
        <input type="file" id="e-photo-lib-v" accept="image/*" style="display:none" onchange="handleEditPhoto(this,'verso')">
        <div id="e-preview-wrap-v" style="display:none;position:absolute;inset:0;" onclick="document.getElementById('e-photo-lib-v').click()">
          <img id="e-preview-img-v" style="width:100%;height:100%;object-fit:cover;">
          <div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.6);border-radius:99px;padding:3px 10px;font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">Changer</div>
        </div>
        <div id="e-placeholder-v"><div style="font-size:22px;"></div>
          <div class="photo-btns">
            <button class="photo-btn" type="button" onclick="document.getElementById('e-photo-lib-v').click()">Biblioth√®que</button>
          </div>
        </div>
      </div>
      <button class="crop-btn" id="e-crop-btn-v" style="display:none;margin-bottom:8px;" onclick="openCrop('edit-verso')">Recadrer verso</button>
    </div>
    <div class="form-group"><label class="form-label">Pr√©nom</label><input class="form-input" id="e-prenom" type="text"></div>
    <div class="form-group"><label class="form-label">Nom</label><input class="form-input" id="e-nom" type="text"></div>
    <div class="form-group"><label class="form-label">Sport</label>
      <select class="form-select" id="e-sport" onchange="onEditSportChange()">
        <option value="">S√©lectionner</option>
        <option value="football">Football</option>
        <option value="basketball">Basketball</option>
        <option value="baseball">Baseball</option>
        <option value="nfl">NFL</option>
        <option value="nhl">NHL</option>
        <option value="tennis">Tennis</option>
        <option value="f1">F1</option>
        <option value="autre">Autre</option>
      </select>
    </div>
    <div class="form-group" id="e-club-group" style="display:none;">
      <label class="form-label">Club / √âquipe</label>
      <div class="club-search-wrap">
        <input class="form-input" id="e-club-search" type="text" placeholder="Rechercher un club‚Ä¶" oninput="clubSearch(this.value,'e')" onfocus="clubSearch(this.value,'e')" autocomplete="off">
        <div class="club-dropdown" id="e-club-dropdown"></div>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Num√©rot√©e (/X)</label><input class="form-input" id="e-num" type="text" placeholder="/25"></div>
    <div class="form-group"><label class="form-label">Sp√©cificit√©s</label><div class="toggle-row"><button class="toggle-btn" id="e-tog-auto" onclick="eTogTag('auto')">Auto</button><button class="toggle-btn" id="e-tog-patch" onclick="eTogTag('patch')">Patch</button><button class="toggle-btn" id="e-tog-rookie" onclick="eTogTag('rookie')">Rookie</button></div></div>
    <div class="form-group"><label class="form-label">Marque</label>
      <select class="form-select" id="e-marque" onchange="onMarqueChange('e')">
        <option value="">S√©lectionner</option>
        <option value="Topps">Topps</option>
        <option value="Panini">Panini</option>
        <option value="Leaf">Leaf</option>
        <option value="Futera">Futera</option>
        <option value="Daka">Daka</option>
        <option value="Autre">Autre</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Ann√©e</label><select class="form-select" id="e-annee"></select></div>
    <div class="form-group" id="e-set-group" style="display:none;"><label class="form-label">Collection / Set</label><select class="form-select" id="e-set"></select></div>
    <div class="form-group"><label class="form-label">Dossier</label><select class="form-select" id="e-collection" onchange="onEditCollChange()"></select></div>
    <div id="e-new-coll-wrap" style="display:none;margin-bottom:13px;"><input class="form-input" id="e-new-coll" type="text" placeholder="Nom du nouveau dossier"></div>
    <div class="form-group"><label class="form-label">Prix estim√© (‚Ç¨)</label><input class="form-input" id="e-price" type="number" placeholder="0.00" step="0.01" min="0"></div>
    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="e-notes" rows="3"></textarea></div>
    <button class="btn-primary" onclick="saveEdit()">Sauvegarder</button>
  </div>
</div>

<!-- CROP -->
<div class="crop-overlay" id="crop-overlay">
  <div class="crop-label" id="crop-label">Ajuste le cadrage</div>
  <div class="crop-wrap">
    <canvas id="crop-canvas" class="crop-canvas"></canvas>
    <img id="crop-img" class="crop-img" draggable="false" style="display:none;">
    <div class="crop-frame"></div>
  </div>
  <div class="crop-hint">Glisse pour repositionner</div>
  <div class="crop-controls" id="crop-controls">
    <div class="cc-row"><span class="cc-lbl">Taille</span><input id="crop-size" type="range" min="0.45" max="0.95" step="0.01" value="0.78"></div>
    <div class="cc-row"><span class="cc-lbl">Zoom</span><input id="crop-zoom" type="range" min="1" max="2.4" step="0.01" value="1"></div>
    <div class="cc-row"><span class="cc-lbl">Lumi√®re</span><input id="crop-brightness" type="range" min="0.7" max="1.4" step="0.01" value="1"></div>
    <div class="cc-row"><span class="cc-lbl">Contraste</span><input id="crop-contrast" type="range" min="0.7" max="1.6" step="0.01" value="1"></div>
    <div class="cc-row"><span class="cc-lbl">Qualit√©</span><input id="crop-quality" type="range" min="0.55" max="1" step="0.01" value="0.88"></div>
    <div class="cc-actions">
      <button class="crop-btn-a" type="button" onclick="cropResetEnhance()">Reset</button>
    </div>
  </div>
  <div class="crop-actions">
    <button class="crop-btn-a" style="background:var(--surface2);color:var(--text);" onclick="closeCrop()">Annuler</button>
    <button class="crop-btn-a" style="background:var(--accent);color:var(--bg);" onclick="applyCrop()">Appliquer</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="assets/app.js"></script>
<script>
/* PAGE: dossier */
let _dossierBrand = 'all';
let _dossierSpec  = 'all';
let _dossierFolderName = '';

async function _pageDossier(){
  const params = new URLSearchParams(location.search);
  const folderId = decodeURIComponent(params.get('id') || '');
  const folderName = decodeURIComponent(params.get('name') || '');
  _dossierFolderName = folderName;

  // Set title
  const folder = (db.folders||[]).find(f=>f.id===folderId) || {name:folderName, emoji:'üìÅ'};
  const el_emoji = document.getElementById('dossier-emoji');
  const el_title = document.getElementById('dossier-title');
  if(el_emoji) el_emoji.textContent = folder.emoji || 'üìÅ';
  if(el_title) el_title.textContent = (folder.name || folderName).toUpperCase();

  _renderDossierBrandFilters();
  _renderDossierGrid();
}

function _getDossierCards(){
  return (db.cards||[]).filter(c=>c.collection===_dossierFolderName);
}

function _getDossierFiltered(){
  let cards = _getDossierCards();
  if(_dossierBrand && _dossierBrand!=='all') cards=cards.filter(c=>c.marque===_dossierBrand);
  if(_dossierSpec==='auto')    cards=cards.filter(c=>c.auto||c.tags?.includes('auto'));
  else if(_dossierSpec==='patch')  cards=cards.filter(c=>c.patch||c.tags?.includes('patch'));
  else if(_dossierSpec==='rookie') cards=cards.filter(c=>c.rookie||c.tags?.includes('rookie'));
  else if(_dossierSpec==='num')    cards=cards.filter(c=>c.isNum||c.num);
  return cards;
}

function _renderDossierBrandFilters(){
  const row = document.getElementById('d-brand-row');
  if(!row) return;
  const cards = _getDossierCards();
  const brands = [...new Set(cards.map(c=>c.marque).filter(Boolean))];
  let html = `<div class="filter-tag brand-filter-btn active" onclick="setDossierBrand('all',this)">Tout</div>`;
  brands.forEach(b=>{
    const logo = typeof BRANDS_DB!=='undefined' && BRANDS_DB[b];
    html += `<div class="filter-tag brand-filter-btn" onclick="setDossierBrand('${b}',this)" style="padding:4px 10px;">
      ${logo?`<img src="${logo}" style="height:20px;max-width:60px;object-fit:contain;display:block;">`:b}
    </div>`;
  });
  row.innerHTML = html;
}

function setDossierBrand(brand, el){
  _dossierBrand = brand;
  document.querySelectorAll('#d-brand-row .brand-filter-btn').forEach(b=>b.classList.remove('active'));
  if(el) el.classList.add('active');
  _renderDossierGrid();
}

function setDossierSpec(spec, el){
  _dossierSpec = spec;
  document.querySelectorAll('#d-spec-row .type-filter').forEach(b=>b.classList.remove('active'));
  if(el) el.classList.add('active');
  _renderDossierGrid();
}

function _renderDossierGrid(){
  const grid = document.getElementById('dossier-grid');
  const empty = document.getElementById('dossier-empty');
  const count = document.getElementById('dossier-count');
  if(!grid) return;
  const cards = _getDossierFiltered();
  const total = _getDossierCards().length;
  if(count) count.textContent = `${total} carte${total!==1?'s':''}`;
  if(!cards.length){
    grid.innerHTML='';
    if(empty) empty.style.display='block';
    return;
  }
  if(empty) empty.style.display='none';
  grid.innerHTML = cards.map(c=>{
    const name = ((c.prenom||'')+' '+(c.nom||'')).trim()||'‚Äî';
    const hasPhoto = c.photo||c.photoUrl;
    return`<div class="coll-thumb" data-card-id="${c.id}" onclick="openCard('${c.id}')">
      ${hasPhoto?`<img src="${hasPhoto}" class="thumb-img" loading="lazy" onerror="this.style.display='none'">`:`<div class="thumb-placeholder"><span>${name.charAt(0)}</span></div>`}
    </div>`;
  }).join('');
}

function navBack(){
  if(document.referrer && document.referrer.includes(location.host)){ history.back(); }
  else{ location.href='collection.html'; }
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadFromDB();
  setupImageViewer && setupImageViewer();
});
</script>
</body>
</html>
