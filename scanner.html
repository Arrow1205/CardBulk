<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;600;700;800;900&family=Barlow:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800&family=Fugaz+One&display=swap" rel="stylesheet">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CardVault">
<meta name="theme-color" content="#0c0c0e">
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAMAEBAAAAEAIABoBAAANgAAAICAgAAABACAAoAkAAMYAAAA=">
<link rel="stylesheet" href="assets/app.css">
<title>CardVault ‚Äî Ajouter</title>
</head>

<body>
  <div class="page">
    <header class="topbar">
      <div class="topbar-title">Scanner</div>
    </header>

    <main class="content" style="padding:16px;">
      <div class="container-ocrv3">
        <h2 style="text-align:center;margin:0 0 14px 0;">ü§ñ Scanner Intelligent v3</h2>

        <div class="upload-area">
          <input type="file" id="imageInput" accept="image/*">
          <img id="preview" alt="Aper√ßu de la carte" />
        </div>

        <div id="loading" style="display:none;text-align:center;padding:16px;font-style:italic;font-weight:600;color:var(--accent);">
          ‚ú® Analyse de l'image, d√©tection des textes, logos, patchs et signatures en cours...
        </div>

        <div id="resultBox" class="result-box" style="display:none;">
          <h3 style="margin:0 0 14px 0;font-size:16px;border-bottom:1px solid rgba(255,255,255,.12);padding-bottom:10px;">
            ‚úÖ R√©sultats de l'analyse :
          </h3>

          <form id="cardForm">
            <div class="form-group">
              <label for="inputPrenom">Pr√©nom</label>
              <input type="text" id="inputPrenom">
            </div>
            <div class="form-group">
              <label for="inputNom">Nom</label>
              <input type="text" id="inputNom">
            </div>
            <div class="form-group">
              <label for="inputClub">Club / √âquipe</label>
              <input type="text" id="inputClub">
            </div>
            <div class="form-group">
              <label for="inputEditeur">√âditeur</label>
              <input type="text" id="inputEditeur" placeholder="Topps / Panini / ...">
            </div>
            <div class="form-group">
              <label for="inputCollection">Collection / Set</label>
              <input type="text" id="inputCollection">
            </div>

            <div class="form-group checkbox-group">
              <label for="inputPatch">
                <input type="checkbox" id="inputPatch"> Contient un Patch / Memorabilia üëï
              </label>
            </div>
            <div class="form-group checkbox-group">
              <label for="inputAuto">
                <input type="checkbox" id="inputAuto"> Contient un Autographe ‚úçÔ∏è
              </label>
            </div>

            <div class="button-group">
              <button type="button" id="resetBtn">Annuler / Recommencer</button>
              <button type="submit" id="saveBtn">Sauvegarder</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <!-- TABBAR -->
<div class="tabbar">
  <button class="tab-btn active" onclick="location.href='index.html'" id="tab-home">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Accueil
  </button>
  <button class="tab-btn scan-btn" onclick="location.href='scanner.html'" id="tab-scanner">
    <div class="scan-circle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="22" height="22" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
  </button>
  <button class="tab-btn" onclick="location.href='collection.html'" id="tab-collection">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>Collection
  </button>
</div>


<!-- CARD DETAIL -->
<div class="card-detail" id="card-detail">
  <div class="card-detail-hdr">
    <button class="back-btn" onclick="closeDetail()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></button>
    <div style="display:flex;gap:8px;">
      
      <button class="detail-fav-btn" id="detail-fav-btn" onclick="toggleFav()"></button>
    </div>
  </div>
  <div class="card-3d-scene card-animated" id="card-3d-scene">
    <!-- Big name BG text (no photo) -->
    <div class="card-bg-name-text" id="card-bg-name-text" style="display:none;"></div>
    <!-- Flip container -->
    <div class="card-flip-container" id="card-flip-container">
      <div class="card-flip-inner" id="card-flip-inner">
        <div class="card-face" id="card-face-front">
          <div class="card-3d-content card-3d-placeholder" id="card-3d-content"><span style="font-size:40px;opacity:.25;">üÉè</span></div>
        </div>
        <div class="card-face card-face-back" id="card-face-back">
          <div class="card-3d-content card-3d-placeholder" id="card-3d-content-back"><span style="font-size:40px;opacity:.25;"></span></div>
        </div>
      </div>
    </div>
    <button class="flip-btn" id="flip-btn" onclick="flipCard()" style="display:none;" title="Retourner la carte"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg></button>
  </div>
  <div class="card-detail-bottom">
    <div class="player-identity">
      <div>
        <div class="player-first" id="detail-prenom" onclick="openPlayer(curCardId)" style="cursor:pointer;"></div>
        <div class="player-last" id="detail-nom" onclick="openPlayer(curCardId)" style="cursor:pointer;">‚Äî</div>
        <div class="player-meta">
          <span id="detail-flag" class="player-flag" style="display:none;"></span>
          <span id="detail-club-logo-wrap" onclick="openClub(db.cards.find(x=>String(x.id)===String(curCardId))?.club||'')" style="cursor:pointer;"></span>
          <span class="player-club" id="detail-club-n" onclick="openClub(db.cards.find(x=>String(x.id)===String(curCardId))?.club||'')" style="cursor:pointer;"></span>
          <span class="sep" id="detail-sep" style="display:none;"></span>
          <span class="player-sport-label" id="detail-sport-label" onclick="openSport(db.cards.find(x=>String(x.id)===String(curCardId))?.sport||'')" style="cursor:pointer;"></span>
        </div>
      </div>
      <div class="player-right" style="display:none;"><div id="detail-num" style="display:none;"></div><div id="detail-badges"></div></div>
    </div>
    <div class="chips-grid" id="chips-grid">
      <div class="chip chip-marque"><div class="chip-label">Marque</div><div class="chip-val" id="d-marque">‚Äî</div></div>
      <div class="chip"><div class="chip-label">Ann√©e</div><div class="chip-val" id="d-annee">‚Äî</div></div>
      <div class="chip"><div class="chip-label">Set</div><div class="chip-val" id="d-set" style="font-size:13px;">‚Äî</div></div>
      <div class="chip" id="chip-tags-row"><div class="chip-label">Sp√©cificit√©s</div><div class="chip-val" id="d-tags-val" style="display:flex;gap:4px;flex-wrap:wrap;align-items:center;padding-top:2px;font-size:12px;">‚Äî</div></div>
      <div class="chip"><div class="chip-label">Dossier</div><div class="chip-val" id="d-coll">‚Äî</div></div>
      <div class="chip"><div class="chip-label">Prix</div><div class="chip-val price-val" id="d-price">‚Äî</div></div>
    </div>
    <div class="detail-notes-wrap" id="d-notes-wrap" style="display:none;">
      <div class="detail-notes-label">Notes</div>
      <div class="detail-notes-val" id="d-notes-val"></div>
    </div>
    <div class="detail-actions">
      <button class="btn-secondary" onclick="editCurrentCard()">Modifier</button>
      <button class="btn-accent" onclick="openPlayerStats()">Stats Joueur</button>
    </div>
  </div>
</div>


<!-- COLL VIEW -->
<div class="coll-view" id="coll-view">
  <div class="coll-view-hdr">
    <button class="back-btn" onclick="closeCollView()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></button>
    <div class="coll-view-title" id="coll-view-title">Dossier</div>
    <div class="btn-icon" onclick="deleteCurrentFolder()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg></div>
  </div>
  <div class="coll-view-body"><div class="colls-grid" id="folder-cards-grid"></div></div>
</div>


<!-- BULK -->
<div class="bulk-bar" id="bulk-bar">
  <button class="btn-secondary" style="flex:0 0 auto;padding:9px 13px;" onclick="cancelBulk()">Annuler</button>
  <select class="form-select" id="bulk-dest" style="flex:1;"></select>
  <button class="btn-accent" style="flex:0 0 auto;padding:9px 13px;" onclick="executeBulk()"></button>
</div>


<!-- EDIT SHEET -->
<div class="sheet-overlay" id="edit-sheet" onclick="closeSheet('edit-sheet',event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Modifier</div>
    <button class="sheet-delete-btn" onclick="deleteCurrentCard()">Supprimer</button>
    <div class="side-tabs">
      <div class="side-tab active" id="edit-tab-recto" onclick="switchEditSide('recto')">Recto</div>
      <div class="side-tab" id="edit-tab-verso" onclick="switchEditSide('verso')">Verso</div>
    </div>
    <div id="edit-recto-zone" style="margin-bottom:10px;">
      <div class="photo-upload" id="edit-photo-zone" style="max-height:180px;">
        <input type="file" id="e-photo-lib" accept="image/*" style="display:none" onchange="handleEditPhoto(this,'recto')">
        <div id="e-preview-wrap" style="display:none;position:absolute;inset:0;" onclick="document.getElementById('e-photo-lib').click()">
          <img id="e-preview-img" style="width:100%;height:100%;object-fit:cover;">
          <div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.6);border-radius:99px;padding:3px 10px;font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">Changer</div>
        </div>
        <div id="e-placeholder"><div style="font-size:22px;"></div>
          <div class="photo-btns">
            <button class="photo-btn" type="button" onclick="document.getElementById('e-photo-lib').click()">Biblioth√®que</button>
          </div>
        </div>
      </div>
      <button class="crop-btn" id="e-crop-btn" style="display:none;margin-bottom:8px;" onclick="openCrop('edit-recto')">Recadrer</button>
    </div>
    <div id="edit-verso-zone" style="display:none;margin-bottom:10px;">
      <div class="photo-upload" id="edit-photo-zone-v" style="max-height:180px;">
        <input type="file" id="e-photo-lib-v" accept="image/*" style="display:none" onchange="handleEditPhoto(this,'verso')">
        <div id="e-preview-wrap-v" style="display:none;position:absolute;inset:0;" onclick="document.getElementById('e-photo-lib-v').click()">
          <img id="e-preview-img-v" style="width:100%;height:100%;object-fit:cover;">
          <div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.6);border-radius:99px;padding:3px 10px;font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">Changer</div>
        </div>
        <div id="e-placeholder-v"><div style="font-size:22px;"></div>
          <div class="photo-btns">
            <button class="photo-btn" type="button" onclick="document.getElementById('e-photo-lib-v').click()">Biblioth√®que</button>
          </div>
        </div>
      </div>
      <button class="crop-btn" id="e-crop-btn-v" style="display:none;margin-bottom:8px;" onclick="openCrop('edit-verso')">Recadrer verso</button>
    </div>
    <div class="form-group"><label class="form-label">Pr√©nom</label><input class="form-input" id="e-prenom" type="text"></div>
    <div class="form-group"><label class="form-label">Nom</label><input class="form-input" id="e-nom" type="text"></div>
    <div class="form-group"><label class="form-label">Sport</label>
      <select class="form-select" id="e-sport" onchange="onEditSportChange()">
        <option value="">S√©lectionner</option>
        <option value="football">Football</option>
        <option value="basketball">Basketball</option>
        <option value="baseball">Baseball</option>
        <option value="nfl">NFL</option>
        <option value="nhl">NHL</option>
        <option value="tennis">Tennis</option>
        <option value="f1">F1</option>
        <option value="autre">Autre</option>
      </select>
    </div>
    <div class="form-group" id="e-club-group" style="display:none;">
      <label class="form-label">Club / √âquipe</label>
      <div class="club-search-wrap">
        <input class="form-input" id="e-club-search" type="text" placeholder="Rechercher un club‚Ä¶" oninput="clubSearch(this.value,'e')" onfocus="clubSearch(this.value,'e')" autocomplete="off">
        <div class="club-dropdown" id="e-club-dropdown"></div>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Num√©rot√©e (/X)</label><input class="form-input" id="e-num" type="text" placeholder="/25"></div>
    <div class="form-group"><label class="form-label">Sp√©cificit√©s</label><div class="toggle-row"><button class="toggle-btn" id="e-tog-auto" onclick="eTogTag('auto')">Auto</button><button class="toggle-btn" id="e-tog-patch" onclick="eTogTag('patch')">Patch</button><button class="toggle-btn" id="e-tog-rookie" onclick="eTogTag('rookie')">Rookie</button></div></div>
    <div class="form-group"><label class="form-label">Marque</label>
      <select class="form-select" id="e-marque" onchange="onMarqueChange('e')">
        <option value="">S√©lectionner</option>
        <option value="Topps">Topps</option>
        <option value="Panini">Panini</option>
        <option value="Leaf">Leaf</option>
        <option value="Futera">Futera</option>
        <option value="Daka">Daka</option>
        <option value="Autre">Autre</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Ann√©e</label>
      <select class="form-select" id="e-annee"></select>
    </div>
    <div class="form-group" id="e-set-group" style="display:none;"><label class="form-label">Collection / Set</label>
      <select class="form-select" id="e-set"></select>
    </div>
    <div class="form-group"><label class="form-label">Dossier</label>
      <select class="form-select" id="e-collection" onchange="onEditCollChange()"></select>
    </div>
    <div id="e-new-coll-wrap" style="display:none;margin-bottom:13px;"><input class="form-input" id="e-new-coll" type="text" placeholder="Nom du nouveau dossier"></div>
    <div class="form-group"><label class="form-label">Prix estim√© (‚Ç¨)</label><input class="form-input" id="e-price" type="number" placeholder="0.00" step="0.01" min="0"></div>
    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="e-notes" rows="3"></textarea></div>
    <button class="btn-primary" onclick="saveEdit()">Sauvegarder</button>
  </div>
</div>


<!-- PLAYER STATS -->
<div class="sheet-overlay" id="player-sheet" onclick="closeSheet('player-sheet',event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div id="player-ai-content"><div class="ai-loading"><div class="ai-spin"></div>Recherche‚Ä¶</div></div>
  </div>
</div>


<!-- FOLDER SHEET -->
<div class="sheet-overlay" id="folder-sheet" onclick="closeSheet('folder-sheet',event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div><div class="sheet-title">Nouveau dossier</div>
    <div class="form-group"><label class="form-label">Nom</label><input class="form-input" id="new-folder-name" type="text" placeholder="ex: Rookies 2024"></div>
    <div class="form-group"><label class="form-label">Ic√¥ne</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)"></span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">‚≠ê</span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)"></span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)"></span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)"></span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)"></span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)"></span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)"></span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)"></span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)"></span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)"></span><span style="cursor:pointer;font-size:22px;" onclick="selEmoji(this)">üÉè</span>
      </div>
    </div>
    <button class="btn-primary" onclick="createFolder()">Cr√©er le dossier</button>
  </div>
</div>


<!-- CROP -->
<div class="crop-overlay" id="crop-overlay">
  <div class="crop-label" id="crop-label">Ajuste le cadrage</div>
  <div class="crop-wrap">
    <canvas id="crop-canvas" class="crop-canvas"></canvas>
    <img id="crop-img" class="crop-img" draggable="false" style="display:none;">
    <div class="crop-frame"></div>
</div>
  <div class="crop-hint">Glisse pour repositionner</div>
  <div class="crop-controls" id="crop-controls">
    <div class="cc-row"><span class="cc-lbl">Taille</span><input id="crop-size" type="range" min="0.45" max="0.95" step="0.01" value="0.78"></div>
    <div class="cc-row"><span class="cc-lbl">Zoom</span><input id="crop-zoom" type="range" min="1" max="2.4" step="0.01" value="1"></div>
    <div class="cc-row"><span class="cc-lbl">Lumi√®re <span id="crop-brightness-pct">100%</span></span><input id="crop-brightness" type="range" min="70" max="140" step="1" value="100"></div>
    <div class="cc-row"><span class="cc-lbl">Contraste <span id="crop-contrast-pct">100%</span></span><input id="crop-contrast" type="range" min="70" max="160" step="1" value="100"></div>
    <div class="cc-row"><span class="cc-lbl">Qualit√©</span><input id="crop-quality" type="range" min="55" max="100" step="1" value="88"></div>
    <div class="cc-actions">
      <button class="crop-btn-a" type="button" onclick="cropResetEnhance()">Reset</button>
    </div>
  </div>
  <div class="crop-actions">
    <button class="crop-btn-a" style="background:var(--surface2);color:var(--text);" onclick="closeCrop()">Annuler</button>
    <button class="crop-btn-a" style="background:var(--accent);color:var(--bg);" onclick="applyCrop()">Appliquer</button>
  </div>
</div>
<div class="toast" id="toast"></div>
<!-- Fullscreen image viewer -->
<div id="img-viewer" class="img-viewer" style="display:none" aria-hidden="true">
  <button id="img-viewer-close" class="img-viewer-close" aria-label="Fermer"></button>
  <img id="img-viewer-img" alt="Carte" />
</div>


<section class="view" id="view-player" style="display:none">
  <div class="hero-top">
    <div class="hero-row">
      <div class="hero-right">
        <button class="icon-btn" type="button" onclick="navBack()" aria-label="Back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></button>
        <div class="hero-name">
          <div class="first" id="player-first">‚Äî</div>
          <div class="last" id="player-last">‚Äî</div>
        </div>
        <div class="hero-chips">
          <div class="chip-pill" id="player-sport-chip" onclick="openSportFromChip()">
            <img id="player-sport-icon" alt="" />
            <span id="player-sport-text">Sport</span>
          </div>
          <div class="chip-pill" id="player-club-chip" onclick="openClubFromChip()">
            <span class="club-badge" id="player-club-badge">CL</span>
            <span id="player-club-text">Club</span>
          </div>
        </div>
      </div>
      <div class="hero-media">
          <img id="player-hero-img" alt="" onclick="triggerPlayerPhoto()" style="cursor:pointer;">
          <button class="hero-photo-btn" type="button" onclick="triggerPlayerPhoto()" aria-label="Ajouter une photo">Ôºã</button>
          <input id="player-photo-input" type="file" accept="image/*" style="display:none" onchange="onPlayerPhotoPicked(event)">
        </div>
    </div>
  </div>
  <div class="info-section">
    <div class="section-title">Clubs</div>
    <div class="pills-row" id="player-clubs-row"></div>

    <div class="section-title">Filtres</div>
    <div class="pills-row" id="player-brand-row"></div>
    <div class="pills-row" style="margin-top:10px" id="player-spec-row"></div>

    <div class="section-title">Cartes</div>
    <div class="cards-grid" id="player-cards-grid"></div>
  </div>
</section>

<section class="view" id="view-sport" style="display:none">
  <div class="hero-top">
    <button class="icon-btn" type="button" onclick="navBack()" aria-label="Back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></button>
    <div class="hero-name">
      <div class="first" id="sport-title-small">Sport</div>
      <div class="last" id="sport-title-big">‚Äî</div>
    </div>
    <div class="hero-chips" style="margin-top:14px">
      <div class="chip-pill">
        <img id="sport-icon" alt="" />
        <span id="sport-text">‚Äî</span>
      </div>
    </div>
  </div>
  <div class="info-section">
    <div class="section-title">Filtres</div>
    <div class="pills-row" id="sport-brand-row"></div>
    <div class="pills-row" style="margin-top:10px" id="sport-spec-row"></div>

    <div class="section-title">Cartes</div>
    <div class="cards-grid" id="sport-cards-grid"></div>
  </div>
</section>

<section class="view" id="view-club" style="display:none">
  <div class="hero-top">
    <div class="hero-row">
      <div class="hero-right">
        <button class="icon-btn" type="button" onclick="navBack()" aria-label="Back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></button>
        <div class="hero-name">
          <div class="first" id="club-title-small">Club</div>
          <div class="last" id="club-title-big">‚Äî</div>
        </div>
        <div class="hero-chips" style="margin-top:14px">
          <div class="chip-pill">
            <span class="club-badge" id="club-badge">CL</span>
            <span id="club-text">‚Äî</span>
          </div>
        </div>
      </div>
      <div class="hero-media">
        <img id="club-hero-img" alt="" onclick="triggerClubLogo()" style="cursor:pointer;">
        <button class="hero-photo-btn" type="button" onclick="triggerClubLogo()" aria-label="Ajouter un logo">Ôºã</button>
        <input id="club-logo-input" type="file" accept="image/*" style="display:none" onchange="onClubLogoPicked(event)">
      </div>
    </div>
</div>
  <div class="info-section">
    <div class="section-title">Filtres</div>
    <div class="pills-row" id="club-brand-row"></div>
    <div class="pills-row" style="margin-top:10px" id="club-spec-row"></div>

    <div class="section-title">Joueurs du club</div>
    <div class="pills-row" id="club-players-row"></div>

    <div class="section-title">Cartes</div>
    <div class="cards-grid" id="club-cards-grid"></div>
  </div>
</section>
<script src="assets/app.js"></script>
<script>
/* PAGE: index ‚Äî init */
document.addEventListener('DOMContentLoaded', ()=>{
  populateYears('f-annee'); populateYears('e-annee');
  loadFromDB();
  setupImageViewer && setupImageViewer();
  initSportDD && initSportDD();
  setupLiveSearch && setupLiveSearch();
});
</script>
</body>
</html>
  <div class="toast" id="toast"></div>

  <style>
    /* Wrapper aligned with app theme */
    .container-ocrv3 {
      background: var(--surface);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .upload-area { position: relative; margin-bottom: 14px; }
    #imageInput {
      display:block; width:100%;
      padding: 14px;
      border: 2px dashed rgba(255,255,255,.25);
      border-radius: 12px;
      cursor: pointer;
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight: 600;
    }
    #imageInput:disabled { opacity:.6; cursor:not-allowed; }
    #preview {
      max-width:100%;
      width:100%;
      height:auto;
      border-radius: 12px;
      margin-top: 12px;
      display:none;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .result-box {
      margin-top: 14px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      background: rgba(255,255,255,.03);
    }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display:block; font-size: 13px; margin-bottom: 6px; font-weight: 700; color: rgba(255,255,255,.85);
    }
    .form-group input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.15);
      color: var(--text);
      border-radius: 10px;
      font-size: 15px;
      box-sizing: border-box;
      outline: none;
    }
    .form-group input[type="text"]:focus { border-color: rgba(255,255,255,.28); }
    .checkbox-group {
      display:flex; align-items:center;
      background: rgba(0,0,0,.12);
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .checkbox-group label {
      margin:0; cursor:pointer; display:flex; align-items:center; width:100%;
      font-weight: 600;
    }
    .checkbox-group input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.15);
      accent-color: var(--accent);
    }
    .button-group { display:flex; gap:10px; margin-top: 14px; }
    .button-group button {
      flex:1; padding: 12px 12px;
      font-size: 15px;
      font-weight: 800;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    #saveBtn { background: var(--accent); color: var(--bg); }
    #resetBtn { background: rgba(255,255,255,.10); color: var(--text); border:1px solid rgba(255,255,255,.12); }
    #saveBtn:disabled { opacity:.6; cursor:not-allowed; }
  </style>

  <script src="assets/app.js"></script>
  <script>
    // --- üö® Mets ta cl√© Gemini ici pour tester (ou remplace par une variable d'env en prod) üö® ---
    const GEMINI_API_KEY = "TA_CLE_API_ICI";
    // ---------------------------------------------------------------------------

    const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    const loading = document.getElementById('loading');
    const resultBox = document.getElementById('resultBox');
    const cardForm = document.getElementById('cardForm');
    const resetBtn = document.getElementById('resetBtn');
    const saveBtn = document.getElementById('saveBtn');

    let base64Data = null;
    let mimeType = null;

    function setTabActive(){
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      const s = document.getElementById('tab-scanner');
      if(s) s.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      setTabActive();
      // utile si tu veux r√©utiliser db plus tard
      try{ loadFromDB && loadFromDB(); }catch(e){}
    });

    imageInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;

      resultBox.style.display = 'none';
      mimeType = file.type;

      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';

      const reader = new FileReader();
      reader.onloadend = function() {
        base64Data = reader.result.split(',')[1];
        analyserCarte();
      };
      reader.readAsDataURL(file);
    });

    async function analyserCarte() {
      if (!base64Data) return;
      if (!GEMINI_API_KEY || GEMINI_API_KEY.length < 20) {
        alert("Cl√© Gemini manquante.");
        return;
      }

      loading.style.display = 'block';
      imageInput.disabled = true;

      const prompt = `
Analyse cette image de carte de sport.
Extrais les informations et renvoie-les UNIQUEMENT sous la forme d'un objet JSON valide avec ces cl√©s exactes :
- "prenom"
- "nom"
- "club" (Nom de l'√©quipe ou du club. D√©tecte-le via le texte √©crit OU via le logo de l'√©quipe s'il est pr√©sent. Si sport individuel sans club, laisse vide).
- "editeur"
- "collection"
- "hasPatch" (bool√©en true/false : y a-t-il un morceau de maillot, tissu ou memorabilia int√©gr√© dans la carte ?)
- "hasAutograph" (bool√©en true/false : y a-t-il une signature manuscrite sur la carte ?)

Ne rajoute aucun texte avant ou apr√®s le JSON.
      `;

      const requestBody = {
        contents: [{
          parts: [
            { text: prompt },
            { inlineData: { mimeType: mimeType, data: base64Data } }
          ]
        }]
      };

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        let rawText = data.candidates[0].content.parts[0].text;
        rawText = rawText.replace(/```json/gi, '').replace(/```/g, '').trim();
        const cardData = JSON.parse(rawText);

        document.getElementById('inputPrenom').value = cardData.prenom || '';
        document.getElementById('inputNom').value = cardData.nom || '';
        document.getElementById('inputClub').value = cardData.club || '';
        document.getElementById('inputEditeur').value = cardData.editeur || '';
        document.getElementById('inputCollection').value = cardData.collection || '';

        document.getElementById('inputPatch').checked = cardData.hasPatch === true;
        document.getElementById('inputAuto').checked = cardData.hasAutograph === true;

        resultBox.style.display = 'block';
        resultBox.scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error(error);
        alert("Erreur d'analyse : " + error.message);
      } finally {
        loading.style.display = 'none';
        imageInput.disabled = false;
      }
    }

    resetBtn.addEventListener('click', function() {
      resultBox.style.display = 'none';
      preview.style.display = 'none';
      loading.style.display = 'none';
      imageInput.value = '';
      imageInput.disabled = false;
      cardForm.reset();
      base64Data = null;
      mimeType = null;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    cardForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const prenom = document.getElementById('inputPrenom').value.trim();
      const nom = document.getElementById('inputNom').value.trim();
      if(!prenom && !nom) {
        showToast && showToast("Saisis au moins un nom");
        return;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = "Sauvegarde‚Ä¶";

      try {
        const id = String(Date.now());
        const dataUrl = mimeType && base64Data ? `data:${mimeType};base64,${base64Data}` : "";
        let photoUrl = "";
        if(dataUrl) {
          photoUrl = await uploadPhoto(dataUrl, id, "recto");
        }

        const tags = [];
        if(document.getElementById('inputPatch').checked) tags.push("patch");
        if(document.getElementById('inputAuto').checked) tags.push("auto");

        const card = {
          id,
          prenom,
          nom,
          club: document.getElementById('inputClub').value.trim(),
          clubEmoji: "",
          sport: "",
          num: "",
          isNum: false,
          tags,
          collection: "",
          notes: "",
          photo: photoUrl,
          photoVerso: "",
          fav: false,
          date: new Date().toLocaleDateString("fr-FR"),
          price: 0,
          marque: document.getElementById('inputEditeur').value.trim(),
          annee: "",
          setName: document.getElementById('inputCollection').value.trim(),
          nationalite: "",
          drapeauEmoji: ""
        };

        await sbInsert("cards", toSB(card));
        // push local db if exists
        try {
          if(window.db && Array.isArray(db.cards)) db.cards.unshift(card);
        } catch(e){}

        showToast && showToast("Carte enregistr√©e !");
        // retour collection
        setTimeout(()=>location.href="collection.html", 350);
      } catch(err) {
        console.error(err);
        showToast && showToast("Erreur : " + (err.message || err));
        alert("Erreur Supabase : " + (err.message || err));
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Sauvegarder";
      }
    });
  </script>
</body>
</html>
