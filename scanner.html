<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;600;700;800;900&family=Barlow:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800&family=Fugaz+One&display=swap" rel="stylesheet">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CardVault">
<meta name="theme-color" content="#0c0c0e">
<link rel="stylesheet" href="assets/app.css">
<title>CardVault ‚Äî Ajouter</title>
<style>
  /* Scanner page ‚Äì aligned to provided mock */
  .scan-page{min-height:100vh;padding:28px 18px 110px;}
  .scan-title{font-family:"Barlow Condensed",system-ui; font-weight:900; letter-spacing:0.02em; font-size:42px; line-height:1; margin:6px 0 8px;}
  .scan-sub{opacity:.65; margin:0 0 16px; font-weight:500;}
  .seg2{display:flex; gap:10px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:6px; width:100%; max-width:520px;}
  .seg2 button{flex:1; border-radius:999px; padding:10px 14px; font-weight:800; letter-spacing:.04em; font-family:"Barlow Condensed",system-ui; text-transform:uppercase; border:0; cursor:pointer; background:transparent; color:rgba(255,255,255,.55);}
  .seg2 button.active{background:var(--accent); color:#05110a;}
  .scan-capture{margin-top:14px; border-radius:18px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04); overflow:hidden; position:relative;}
  .scan-capture-inner{height:150px; display:flex; align-items:center; justify-content:center; gap:28px; color:rgba(255,255,255,.8); font-weight:700;}
  .scan-corner{position:absolute; width:18px; height:18px; border:3px solid var(--accent); }
  .c-tl{top:14px; left:14px; border-right:0; border-bottom:0; border-radius:4px 0 0 0;}
  .c-tr{top:14px; right:14px; border-left:0; border-bottom:0; border-radius:0 4px 0 0;}
  .c-bl{bottom:14px; left:14px; border-right:0; border-top:0; border-radius:0 0 0 4px;}
  .c-br{bottom:14px; right:14px; border-left:0; border-top:0; border-radius:0 0 4px 0;}
  .scan-preview{display:none; width:100%; height:150px; object-fit:cover;}
  .scan-actions{display:flex; justify-content:center; margin:14px 0 8px;}
  .scan-actions button{background:transparent; border:0; color:rgba(255,255,255,.8); font-weight:800; letter-spacing:.02em; cursor:pointer;}
  .form-block{margin-top:16px;}
  .label{font-family:"Barlow Condensed",system-ui; font-weight:900; letter-spacing:.12em; font-size:13px; color:rgba(255,255,255,.7); text-transform:uppercase; margin:18px 0 8px;}
  .field{width:100%; background:transparent; border:0; outline:none; color:rgba(255,255,255,.92); font-size:16px; padding:0 0 10px; border-bottom:1px solid rgba(255,255,255,.14);}
  .field::placeholder{color:rgba(255,255,255,.45);}
  .row2{display:flex; gap:12px;}
  .row2 > div{flex:1;}
  .segYN{display:flex; gap:10px; margin-top:8px;}
  .segYN button{flex:1; border-radius:999px; padding:12px 14px; font-weight:900; font-family:"Barlow Condensed",system-ui; text-transform:uppercase; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.05); color:rgba(255,255,255,.6); cursor:pointer;}
  .segYN button.active{background:var(--accent); color:#06120a; border-color:transparent;}
  .chips3{display:flex; gap:12px; margin-top:10px;}
  .chip{flex:1; border-radius:999px; padding:12px 0; text-align:center; font-weight:900; font-family:"Barlow Condensed",system-ui; text-transform:uppercase; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.05); color:rgba(255,255,255,.65); cursor:pointer;}
  .chip.active{background:var(--accent);color:#06120a;border-color:transparent;}
  .select{appearance:none; -webkit-appearance:none; width:100%; background:transparent; border:0; outline:none; color:rgba(255,255,255,.92); font-size:16px; padding:0 28px 10px 0; border-bottom:1px solid rgba(255,255,255,.14);}
  .select-wrap{position:relative;}
  .select-wrap:after{content:""; position:absolute; right:4px; top:6px; width:14px; height:14px; border-right:2px solid rgba(255,255,255,.5); border-bottom:2px solid rgba(255,255,255,.5); transform:rotate(45deg); pointer-events:none;}
  .save-btn{margin-top:22px; width:100%; border:0; border-radius:999px; padding:16px 18px; font-weight:900; font-family:"Barlow Condensed",system-ui; letter-spacing:.06em; text-transform:uppercase; background:var(--accent); color:#06120a; cursor:pointer;}
  .tiny{font-size:12px; opacity:.6; margin-top:10px;}
  .hidden{display:none!important;}
</style>
</head>
<body>

<div class="page active" id="page-scan">
  <div class="page-inner scan-page">

    <button class="back-btn icon-btn" onclick="history.back()" aria-label="Retour">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 18l-6-6 6-6"/></svg>
    </button>

    <div class="scan-title">AJOUTER</div>
    <div class="scan-sub">Scanne ou upload ta carte</div>

    <div class="seg2" role="tablist" aria-label="Recto Verso">
      <button type="button" id="tab-recto" class="active">RECTO</button>
      <button type="button" id="tab-verso">VERSO</button>
    </div>

    <div class="scan-capture" id="captureBox">
      <div class="scan-corner c-tl"></div><div class="scan-corner c-tr"></div><div class="scan-corner c-bl"></div><div class="scan-corner c-br"></div>
      <img id="previewRecto" class="scan-preview" alt="Aper√ßu recto">
      <img id="previewVerso" class="scan-preview" alt="Aper√ßu verso">
      <div class="scan-capture-inner" id="captureEmpty">
        <button type="button" class="plain" id="btnCamera">Cam√©ra</button>
        <button type="button" class="plain" id="btnLibrary">Biblioth√®que</button>
      </div>
    </div>

    <div class="scan-actions">
      <button type="button" id="btnOCR">Analyser (OCR)</button>
    </div>

    <div class="form-block">
      <div class="label">PR√âNOM</div>
      <input class="field" id="fPrenom" placeholder="‚Äî" autocomplete="off"/>

      <div class="label">NOM</div>
      <input class="field" id="fNom" placeholder="‚Äî" autocomplete="off"/>

      <div class="label">SPORT</div>
      <div class="select-wrap">
        <select class="select" id="fSport">
          <option value="">S√©lectionner</option>
          <option value="Football">Football</option>
          <option value="Basketball">Basketball</option>
          <option value="Baseball">Baseball</option>
          <option value="Hockey">Hockey</option>
          <option value="Tennis">Tennis</option>
        </select>
      </div>

<div id="clubGroup" class="fieldGroup hidden">
  <div class="label">CLUB</div>
  <div class="clubWrap">
    <input class="field" id="fClub" placeholder="Rechercher un club" autocomplete="off"/>
    <div id="clubDropdown" class="clubDropdown"></div>
  </div>
</div>

      <div class="label">NUM√âROT√âE</div>
      <div class="segYN">
        <button type="button" id="numNon" class="active">NON</button>
        <button type="button" id="numOui">OUI</button>
      </div>

      <div class="label">SP√âCIFICIT√âS</div>
      <div class="chips3">
        <button type="button" class="chip" data-tag="auto">AUTO</button>
        <button type="button" class="chip" data-tag="patch">PATCH</button>
        <button type="button" class="chip" data-tag="rookie">ROOKIE</button>
      </div>

      <div class="label">MARQUE</div>
      <div class="select-wrap">
        <select class="select" id="fMarque">
          <option value="">S√©lectionner</option>
        </select>
      </div>

      <div class="label">COLLECTION</div>
      <input class="field" id="fSetName" placeholder="S√©lectionner" autocomplete="off"/>

      <div class="label">ANN√âE</div>
      <div class="select-wrap">
        <select class="select" id="fAnnee">
          <option value="">S√©lectionner</option>
          <option>2026</option><option>2025</option><option>2024</option><option>2023</option><option>2022</option><option>2021</option><option>2020</option>
          <option>2019</option><option>2018</option><option>2017</option><option>2016</option><option>2015</option>
        </select>
      </div>

      <div class="label">DOSSIER</div>
      <input class="field" id="fCollection" placeholder="" autocomplete="off"/>

      <div class="label">PRIX ESTIM√â (‚Ç¨)</div>
      <input class="field" id="fPrice" value="0.00" inputmode="decimal"/>

      <button class="save-btn" id="btnSave">ENREGISTRER LA CARTE</button>
      <div class="tiny" id="scanStatus"></div>
    </div>

  </div>
</div>

<!-- TABBAR -->
<div class="tabbar">
  <button class="tab-btn" onclick="location.href='index.html'" id="tab-home">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Accueil
  </button>
  <button class="tab-btn scan-btn active" onclick="location.href='scanner.html'" id="tab-scanner">
    <div class="scan-circle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5v14"/><path d="M5 12h14"/></svg></div>
  </button>
  <button class="tab-btn" onclick="location.href='collection.html'" id="tab-collection">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Collection
  </button>
</div>

<script src="assets/app.js"></script>
<script>
function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));}

  // OCR via Vercel API route: POST /api/ocr (Gemini key stays server-side)

  const tabRecto = document.getElementById('tab-recto');
  const tabVerso = document.getElementById('tab-verso');

  const previewRecto = document.getElementById('previewRecto');
  const previewVerso = document.getElementById('previewVerso');
  const captureEmpty = document.getElementById('captureEmpty');

  const btnCamera = document.getElementById('btnCamera');
  const btnLibrary = document.getElementById('btnLibrary');
  const btnOCR = document.getElementById('btnOCR');
  const btnSave = document.getElementById('btnSave');
  const statusEl = document.getElementById('scanStatus');

  const fPrenom = document.getElementById('fPrenom');
  const fNom = document.getElementById('fNom');
  const fMarque = document.getElementById('fMarque');
  const fSetName = document.getElementById('fSetName');

  const fSport = document.getElementById('fSport');
let CLUBS_DATA = null;

async function loadClubsJson(){
  if(CLUBS_DATA) return CLUBS_DATA;
  const r = await fetch("/clubs.json", { cache: "force-cache" });
  if(!r.ok) throw new Error("clubs.json introuvable");
  CLUBS_DATA = await r.json();
  return CLUBS_DATA;
}

function isTeamSport(s){
  const v = String(s||"").toLowerCase();
  return ["football","basketball","baseball"].includes(v);
}

async function updateClubVisibility(){
  const s = fSport.value;
  const show = isTeamSport(s);
  const g = document.getElementById("clubGroup");
  if(g) g.classList.toggle("hidden", !show);
  if(!show){
    document.getElementById("fClub").value = "";
    const dd = document.getElementById("clubDropdown");
    dd.classList.remove("open"); dd.innerHTML="";
  }
}

function norm(str){ return String(str||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,""); }

async function clubSearch(q){
  const dd = document.getElementById("clubDropdown");
  const term = norm(q).trim();
  if(!term){ dd.classList.remove("open"); dd.innerHTML=""; return; }
  let data;
  try{ data = await loadClubsJson(); }catch(e){ dd.classList.remove("open"); return; }
  const list = (data[fSport.value] || []);
  const hits = list.filter(c=>{
    const n = norm(c.name);
    if(n.includes(term)) return true;
    return (c.aliases||[]).some(a=>norm(a).includes(term));
  }).slice(0,10);

  dd.innerHTML = hits.map(c=>{
    const logo = c.logo ? `<img src="${c.logo}" alt="">` : `<span style="font-size:18px;">üèüÔ∏è</span>`;
    const meta = [c.country, c.league].filter(Boolean).join(" ‚Ä¢ ");
    return `<div class="clubItem" data-name="${c.name.replace(/"/g,'&quot;')}">
      <div class="clubLogo">${logo}</div>
      <div>
        <div class="clubName">${escapeHtml(c.name)}</div>
        <div class="clubMeta">${escapeHtml(meta)}</div>
      </div>
    </div>`;
  }).join("");

  dd.classList.toggle("open", hits.length>0);

  dd.querySelectorAll(".clubItem").forEach(el=>{
    el.addEventListener("click", ()=>{
      document.getElementById("fClub").value = el.getAttribute("data-name") || "";
      dd.classList.remove("open"); dd.innerHTML="";
    });
  });
}
  const fAnnee = document.getElementById('fAnnee');
  const fCollection = document.getElementById('fCollection');
  const fPrice = document.getElementById('fPrice');

  const numNon = document.getElementById('numNon');
  const numOui = document.getElementById('numOui');

  let activeSide = "recto";
  let rectoDataUrl = "";
  let versoDataUrl = "";

  // hidden file inputs
  const inputCamera = document.createElement('input');
  inputCamera.type = 'file';
  inputCamera.accept = 'image/*';
  inputCamera.capture = 'environment';

  const inputLibrary = document.createElement('input');
  inputLibrary.type = 'file';
  inputLibrary.accept = 'image/*';

  function setActiveSide(side){
    activeSide = side;
    tabRecto.classList.toggle('active', side==='recto');
    tabVerso.classList.toggle('active', side==='verso');

    previewRecto.style.display = (side==='recto' && rectoDataUrl) ? 'block' : 'none';
    previewVerso.style.display = (side==='verso' && versoDataUrl) ? 'block' : 'none';

    const hasAny = (side==='recto' ? rectoDataUrl : versoDataUrl);
    captureEmpty.classList.toggle('hidden', !!hasAny);
  }

  tabRecto.addEventListener('click', ()=>setActiveSide('recto'));
  tabVerso.addEventListener('click', ()=>setActiveSide('verso'));

  function setPreview(dataUrl){
  imgDataUrl = dataUrl;

    if(activeSide==='recto'){
      rectoDataUrl = dataUrl;
      previewRecto.src = dataUrl;
    } else {
      versoDataUrl = dataUrl;
      previewVerso.src = dataUrl;
    }
    captureEmpty.classList.add('hidden');
    previewRecto.style.display = (activeSide==='recto') ? 'block' : 'none';
    previewVerso.style.display = (activeSide==='verso') ? 'block' : 'none';
  }

  function handleFile(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async ()=>{ setPreview(reader.result); if(activeSide==="recto"){ try{ await analyserOCR(); }catch(e){} } };
    reader.readAsDataURL(file);
  }

  btnCamera.addEventListener('click', ()=> inputCamera.click());
  btnLibrary.addEventListener('click', ()=> inputLibrary.click());
  inputCamera.addEventListener('change', (e)=> handleFile(e.target.files[0]));
  inputLibrary.addEventListener('change', (e)=> handleFile(e.target.files[0]));

  // tags
  const chips = Array.from(document.querySelectorAll('.chip'));
  const activeTags = new Set();
  chips.forEach(ch=>{
    ch.addEventListener('click', ()=>{
      const tag = ch.dataset.tag;
      if(activeTags.has(tag)){ activeTags.delete(tag); ch.classList.remove('active'); }
      else { activeTags.add(tag); ch.classList.add('active'); }
    });
  });

  // num
  let isNum = false;
  function setNum(v){
    isNum = v;
    numNon.classList.toggle('active', !v);
    numOui.classList.toggle('active', v);
  }
  numNon.addEventListener('click', ()=>setNum(false));
  numOui.addEventListener('click', ()=>setNum(true));

  // Brands: static list (no DB dependency)
  (function populateBrands(){
    const brands = ["Topps","Panini","Leaf","Futera","Daka","Upper Deck"];
    for(const n of brands){
      const opt = document.createElement('option');
      opt.value = n;
      opt.textContent = n;
      fMarque.appendChild(opt);
    }
  })();

  function uiBusy(on, msg){
    btnOCR.disabled = on;
    btnSave.disabled = on;
    statusEl.textContent = msg || "";
  }


  async function blobToJpegBase64(blob, maxSide=1280, quality=0.82){
    const bmp = await createImageBitmap(blob);
    let w = bmp.width, h = bmp.height;
    const scale = Math.min(1, maxSide / Math.max(w,h));
    w = Math.round(w*scale); h = Math.round(h*scale);
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(bmp,0,0,w,h);
    const dataUrl = canvas.toDataURL('image/jpeg', quality);
    return { mimeType: 'image/jpeg', base64Data: dataUrl.split(',')[1] || '', dataUrl };
  }

  async function analyserOCR(){
  if(!imgDataUrl){ alert("Ajoute une image recto"); return; }
  try{
    setLoading(true);
    const payload = await dataUrlToCompressedPayload(imgDataUrl);
    const r = await fetch("/api/ocr",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(data?.error || `Erreur OCR (${r.status})`);
    // prefill
    fPrenom.value = (data.prenom||"").trim();
    fNom.value = (data.nom||"").trim();
    const b = (data.marque||"").trim();
    if(b){
      const opt = [...fMarque.options].find(o=>o.value.toLowerCase()===b.toLowerCase());
      if(opt) fMarque.value = opt.value;
      else {
        const o = document.createElement("option");
        o.value = b; o.textContent = b;
        fMarque.appendChild(o);
        fMarque.value = b;
      }
    }
    fSet.value = (data.collection||"").trim();
  }catch(e){
    console.error(e);
    alert(e.message || "Erreur OCR");
  }finally{
    setLoading(false);
  }
}

  btnOCR.addEventListener('click', analyserOCR);

  async function saveCard(){
    uiBusy(true, "Sauvegarde‚Ä¶");

    try{
      // Build card object consistent with app schema
      const card = {
        id: (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : (String(Date.now())+Math.random().toString(16).slice(2)),
        prenom: (fPrenom.value || "").trim(),
        nom: (fNom.value || "").trim(),
        sport: (fSport.value || "").trim(),
        isNum: !!isNum,
        tags: Array.from(activeTags),
        marque: (fMarque.value || "").trim(),
        setName: (fSetName.value || "").trim(),
        annee: (fAnnee.value || "").trim(),
        collection: (fCollection.value || "").trim(),
        price: parseFloat(String(fPrice.value || "0").replace(',','.')) || 0,
        photo: "",
        photoVerso: ""
      };

      // 1) insert
      const inserted = await sbInsert("cards", toSB(card));
      const row = Array.isArray(inserted) ? inserted[0] : inserted;
      const id = row?.id;
      if(!id) throw new Error("Insert OK mais id manquant.");

      // 2) upload photos
      let rectoUrl = "";
      let versoUrl = "";
      if(rectoDataUrl) rectoUrl = await uploadPhoto(rectoDataUrl, id, "recto");
      if(versoDataUrl) versoUrl = await uploadPhoto(versoDataUrl, id, "verso");

      // 3) patch card
      const patch = {};
      if(rectoUrl) patch.photo_url = rectoUrl;
      if(versoUrl) patch.photo_verso_url = versoUrl;
      if(Object.keys(patch).length) await sbUpdate("cards", id, patch);

      uiBusy(false, "");
      location.href = `card.html?id=${encodeURIComponent(id)}`;
    }catch(e){
      console.error(e);
      uiBusy(false, "");
      alert("Erreur sauvegarde : " + e.message);
    }
  }

  btnSave.addEventListener('click', (e)=>{ e.preventDefault(); saveCard(); });

  // init
  setActiveSide('recto');
  setNum(false);
</script>

</body>
</html>
