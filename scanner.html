<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;600;700;800;900&family=Barlow:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800&family=Fugaz+One&display=swap" rel="stylesheet">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CardVault">
<meta name="theme-color" content="#0c0c0e">
<link rel="stylesheet" href="assets/app.css">
<title>CardVault — Ajouter</title>
</head>
<body>

<div class="page active" id="page-scanner">
  <div class="page-inner">
    <div class="scanner-hdr"><div class="scanner-title">Ajouter</div><div class="scanner-sub">Scanne ou uploade ta carte</div></div>
    <div style="padding:0 20px;">
      
      <div class="side-tabs">
        <div class="side-tab active" id="add-tab-recto" onclick="switchAddSide('recto')">Recto</div>
        <div class="side-tab" id="add-tab-verso" onclick="switchAddSide('verso')">Verso</div>
      </div>

      <div id="add-recto-zone">
        <div class="photo-upload" id="photo-upload-zone">
          <input type="file" id="card-photo-lib" accept="image/*" style="display:none" onchange="handlePhoto(this,'recto')">
          <input type="file" id="card-photo-cam" accept="image/*" capture="environment" style="display:none" onchange="handlePhoto(this,'recto')">
          
          <div id="photo-preview-wrap" style="display:none;position:absolute;inset:0;" onclick="document.getElementById('card-photo-lib').click()">
            <img id="photo-preview-img" style="width:100%;height:100%;object-fit:cover;">
            <div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.6);border-radius:99px;padding:3px 10px;font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">Changer</div>
          </div>
          <div id="photo-placeholder-ui"><div style="font-size:28px;"></div>
            <div class="photo-btns">
              <button class="photo-btn" type="button" onclick="document.getElementById('card-photo-cam').click()">Caméra</button>
              <button class="photo-btn" type="button" onclick="document.getElementById('card-photo-lib').click()">Bibliothèque</button>
            </div>
          </div>
        </div>
        <button class="btn-secondary" id="ocr-btn" style="margin-top:10px; width:100%;" type="button" onclick="ocrCard()">Analyser (OCR)</button>
        <div id="scanStatus" style="text-align:center; font-size:12px; margin-top:5px; color:var(--accent);"></div>
      </div>

      <div id="add-verso-zone" style="display:none;">
        <div class="photo-upload" id="photo-upload-zone-v">
          <input type="file" id="card-photo-lib-v" accept="image/*" style="display:none" onchange="handlePhoto(this,'verso')">
          <input type="file" id="card-photo-cam-v" accept="image/*" capture="environment" style="display:none" onchange="handlePhoto(this,'verso')">
          <div id="photo-preview-wrap-v" style="display:none;position:absolute;inset:0;" onclick="document.getElementById('card-photo-lib-v').click()">
            <img id="photo-preview-img-v" style="width:100%;height:100%;object-fit:cover;">
          </div>
          <div id="photo-placeholder-ui-v"><div style="font-size:28px;"></div>
            <div class="photo-btns">
              <button class="photo-btn" type="button" onclick="document.getElementById('card-photo-cam-v').click()">Caméra</button>
              <button class="photo-btn" type="button" onclick="document.getElementById('card-photo-lib-v').click()">Bibliothèque</button>
            </div>
          </div>
        </div>
      </div>

      <div style="height:14px;"></div>
      
      <div class="form-group"><label class="form-label">Prénom</label><input class="form-input" id="f-prenom" type="text" placeholder="Kylian" autocomplete="off"></div>
      <div class="form-group"><label class="form-label">Nom</label><input class="form-input" id="f-nom" type="text" placeholder="Mbappé" autocomplete="off"></div>
      
      <div class="form-group"><label class="form-label">Sport</label>
        <div class="sport-select-wrap"><select class="form-select" id="f-sport">
          <option value="">Sélectionner</option>
          <option value="football">Football / Soccer</option>
          <option value="basketball">Basketball</option>
          <option value="baseball">Baseball</option>
          <option value="tennis">Tennis</option>
          <option value="f1">Formule 1</option>
        </select></div>
      </div>

      <div class="form-group"><label class="form-label">Marque</label>
        <select class="form-select" id="f-marque">
          <option value="">Sélectionner</option>
          <option value="Topps">Topps</option>
          <option value="Panini">Panini</option>
          <option value="Leaf">Leaf</option>
          <option value="Futera">Futera</option>
          <option value="Daka">Daka</option>
          <option value="Upper Deck">Upper Deck</option>
        </select>
      </div>

      <div class="form-group"><label class="form-label">Collection / Set</label>
        <input class="form-input" id="f-set" type="text" placeholder="Prizm, Chrome..." autocomplete="off">
      </div>

      <div class="form-group"><label class="form-label">Dossier / Classeur</label><input class="form-input" id="f-collection" type="text" placeholder="Ex: Cartes PC"></div>
      
      <div class="form-group"><label class="form-label">Prix estimé (€)</label><input class="form-input" id="f-price" type="number" placeholder="0.00" step="0.01" min="0"></div>
      
      <button class="btn-primary" id="save-card-btn" onclick="saveCard()" style="margin-top:20px;">Enregistrer la carte</button>
      <div style="height:22px;"></div>
    </div>
  </div>
</div>

<div class="tabbar">
  <button class="tab-btn" onclick="location.href='index.html'" id="tab-home">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Accueil
  </button>
  <button class="tab-btn scan-btn active" onclick="location.href='scanner.html'" id="tab-scanner">
    <div class="scan-circle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="22" height="22" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
  </button>
  <button class="tab-btn" onclick="location.href='collection.html'" id="tab-collection">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>Collection
  </button>
</div>

<script src="assets/app.js"></script>
<script>
  let rectoDataUrl = "";
  let versoDataUrl = "";
  let activeSide = "recto";

  window.switchAddSide = function(side) {
    activeSide = side;
    document.getElementById('add-tab-recto').classList.toggle('active', side === 'recto');
    document.getElementById('add-tab-verso').classList.toggle('active', side === 'verso');
    document.getElementById('add-recto-zone').style.display = (side === 'recto') ? 'block' : 'none';
    document.getElementById('add-verso-zone').style.display = (side === 'verso') ? 'block' : 'none';
  };

  window.handlePhoto = function(input, side) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      if (side === 'recto') {
        rectoDataUrl = reader.result;
        document.getElementById('photo-preview-img').src = reader.result;
        document.getElementById('photo-preview-wrap').style.display = 'block';
        document.getElementById('photo-placeholder-ui').style.display = 'none';
      } else {
        versoDataUrl = reader.result;
        document.getElementById('photo-preview-img-v').src = reader.result;
        document.getElementById('photo-preview-wrap-v').style.display = 'block';
        document.getElementById('photo-placeholder-ui-v').style.display = 'none';
      }
    };
    reader.readAsDataURL(file);
  };

  function uiBusy(on, msg){
    document.getElementById('ocr-btn').disabled = on;
    document.getElementById('save-card-btn').disabled = on;
    document.getElementById('scanStatus').textContent = msg || "";
  }

  // APPEL À L'IA GEMINI
  window.ocrCard = async function() {
    if (!rectoDataUrl) {
      alert("Veuillez d'abord uploader une image de la carte (Recto).");
      return;
    }
    
    uiBusy(true, "Analyse de la carte par l'IA...");
    
    try {
      const match = rectoDataUrl.match(/^data:(image\/[a-zA-Z+]+);base64,(.+)$/);
      if (!match) throw new Error("Format d'image non reconnu.");
      const mimeType = match[1];
      const base64Data = match[2];

      const res = await fetch('/api/ocr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mimeType, base64Data })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Erreur lors de l'analyse.");

      // Remplissage ciblé sur tes inputs HTML
      if (data.prenom) document.getElementById('f-prenom').value = data.prenom;
      if (data.nom) document.getElementById('f-nom').value = data.nom;
      if (data.marque) document.getElementById('f-marque').value = data.marque;
      if (data.collection) document.getElementById('f-set').value = data.collection;

      uiBusy(false, "Analyse terminée avec succès !");
      setTimeout(() => { document.getElementById('scanStatus').textContent = ""; }, 3000);
      
    } catch (e) {
      console.error(e);
      uiBusy(false, "Échec de l'IA.");
      alert("Erreur OCR : " + e.message);
    }
  };

  // SAUVEGARDE EN BASE
  window.saveCard = async function(){
    uiBusy(true, "Sauvegarde dans le Vault...");

    try {
      const card = {
        id: crypto.randomUUID(),
        prenom: (document.getElementById('f-prenom').value || "").trim(),
        nom: (document.getElementById('f-nom').value || "").trim(),
        sport: (document.getElementById('f-sport').value || "").trim(),
        marque: (document.getElementById('f-marque').value || "").trim(),
        setName: (document.getElementById('f-set').value || "").trim(),
        collection: (document.getElementById('f-collection').value || "").trim(),
        price: parseFloat(document.getElementById('f-price').value || "0") || 0,
        photo: "",
        photoVerso: ""
      };

      const inserted = await sbInsert("cards", toSB(card));
      const row = Array.isArray(inserted) ? inserted[0] : inserted;
      const id = row?.id;
      if(!id) throw new Error("Erreur de création d'ID.");

      let rectoUrl = "";
      let versoUrl = "";
      if(rectoDataUrl) rectoUrl = await uploadPhoto(rectoDataUrl, id, "recto");
      if(versoDataUrl) versoUrl = await uploadPhoto(versoDataUrl, id, "verso");

      const patch = {};
      if(rectoUrl) patch.photo_url = rectoUrl;
      if(versoUrl) patch.photo_verso_url = versoUrl;
      if(Object.keys(patch).length) await sbUpdate("cards", id, patch);

      uiBusy(false, "");
      // Redirection vers le profil
      location.href = `card.html?id=${encodeURIComponent(id)}`;
    } catch(e) {
      console.error(e);
      uiBusy(false, "");
      alert("Erreur de sauvegarde : " + e.message);
    }
  };
</script>

</body>
</html>
